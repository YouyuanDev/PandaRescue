<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css" />
    <link rel="stylesheet" type="text/css" href="./css/aui.css" />
    <link rel="stylesheet" href="./css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="./css/style.css" />
    <style type="text/css">
        .wrap {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-flex-flow: column;
        }

        header {
            height: 60px;
            width: 100%;
            text-align: center;
            background-color: #81a9c3;
            color: #fff;
            line-height: 44px;
            font-size: 20px;
        }

        .flex-1 {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
        }

        footer {
            height: 30px;
            width: 100%;
            background-color: #81a9c3;
            color: white;
            line-height: 30px;
            text-align: center;
        }

        .poilist-container {
            position: absolute;
            bottom: 4px;
            width: 100%;
            height: 200px;
            z-index: 9999999;
            background-color: red;
        }

        .poilist-ul li {
            padding: 5px 0px;
            border-bottom: 1px solid #000;
        }

        .fa-size {
            font-size: 1.2rem;
        }

        .message-dot {
            display: none;
        }
    </style>
</head>

<body class="wrap">
    <header id="header" class="aui-bar aui-bar-nav pr-bgcolor">
        <a class="aui-pull-left aui-btn" onclick="openAccount();">
            <i class="fa fa-user-circle-o fa-size"></i>
        </a>
        <div class="aui-title">
            <span class="item-account-type">普通用户</span>
        </div>
        <a class="aui-pull-right aui-btn" onclick="openConversation();">
            <i class="fa fa-commenting fa-2x fa-size"></i>
            <div class="aui-dot message-dot"></div>
        </a>
    </header>
    <section class="flex-1">

    </section>
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="./script/common.js"></script>
<script type="text/javascript" src="./script/jquery.i18n1.properties-1.0.9.js"></script>
<script type="text/javascript" src="./script/language.js"></script>
<script src="../../script/sha1.js" type="text/javascript"></script>
<script type="text/javascript">
    //我的坐标
    var g_my_lon, g_my_lat;
    //百度地图
    var map;
    //定义融云即时通信
    var rong;
    //刷新坐标的定时器
    var g_PersonUserAndCompanyUserLocationInterval = -1;
    //商户列表,待接单列表
    var g_CompanyList = [],g_PendingOrderList=[];
    //订单状态
    var g_order_status = "";
    //账户类型
    var g_account_type = "person_user";
    //选中待接单订单
    var g_selected_pending_order_no;
    //服务类型集合
    var g_service_type_dict = {};
    //故障类型集合
    var g_failure_type_dict = {};
    apiready = function() {
        fnSettingHeader();
        map = api.require('bMap');
        rong = api.require('rongCloud2');
        initRong();
        registerLoadAllServiceTypeEvent();
        registerLoadAllFaultTypeEvent();
        loadAllServiceType();
        loadAllFaultType();
        loadAllOrderStatus();
        registLocatingEvent();
        registRefreshEvent();
        registerLocatingPersonUserLocationEvent();
        registerStopUpdateUserLocation();
        registLocatingCompanyLocationEvent();
        registerLoadNearbyCompanyEvent();
        registerSetPendingOrderAnnotationsEvent();
        registerReloginEvent();
        registerCompanyListEvent();
        setPushListener();
        registerReceiptEvent();
        registerChangeAccountTypeEvent();
        registerPauseResumeEvent();
        registerMaskEvent();
        registerSwitchAccountTypeEvent();
        initMapSDK();
    };
    //1.初始化MapSDK
    function initMapSDK() {
        if (api.systemType == "ios") {
            map.initMapSDK(function(ret) {
                if (ret.status) {
                    openbMap();
                } else {
                    toastFail('地图打开失败，无法使用定位！');
                }
            });
        } else {
            openbMap();
        }
    }
    //2.初始化成功打开Map
    function openbMap() {
        map.open({
            rect: {
                x: 0,
                y: 70,
                w: api.winWidth,
                h: api.winHeight
            },
            center: {
                lon: 121.377462,
                lat: 31.47022
            },
            zoomLevel: 17,
            showUserLocation: true,
            fixed: false
        }, function(ret) {
            if (ret.status) {
                setTimeout(function() {
                showUserLocation();
                }, 100);
                setTimeout(function() {
                    getLocationServices();
                }, 200);
                openRefreshButton();
            } else {
                toastFail('地图打开失败，无法使用定位！');
            }
        });

    }
    //3.设置是否显示用户位置
    function showUserLocation() {
        map.showUserLocation({
            isShow: true,
            trackingMode: 'none'
        });
    }
    //4.判断用户是否开启定位服务
    function getLocationServices() {
        map.getLocationServices(function(ret, err) {
            if (ret.enable) {
                getUserLocation();
            } else {
                alert("未开启定位功能！");
            }
        });
    }
    //5.获取用户位置信息
    function getUserLocation() {
        map.getLocation({
            accuracy: '10m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
              g_my_lon = ret.lon;
              g_my_lat = ret.lat;
              initMapSDKOK();
            } else {
                map.stopLocation();
                toastFail('定位失败,刷新重试!');
            }
        });
        // map.getCurrentLocation(
        //     function(ret, err) {
        //         if (ret.status) {
        //             g_my_lon = ret.lon;
        //             g_my_lat = ret.lat;
        //             initMapSDKOK();
        //         } else {
        //             map.stopLocation();
        //             toastFail('getUserLocation 失败');
        //         }
        //     });
    }
    //初始化地图成功,获取最新订单信息
    function initMapSDKOK() {
        getCurrentOrder();
    }
    //注册app前台，后台切换事件
    function registerPauseResumeEvent() {
        //监听用户重新打开程序事件
        api.addEventListener({
            name: 'resume'
        }, function(ret, err) {
            getCurrentOrder();
        });
        //监听应用进入后台事件
        // api.addEventListener({
        //     name: 'pause'
        // }, function(ret, err) {
        //     toastSuccess('应用进入后台');
        // });
    }
    //百度地图设置商户标注信息
    function setCompanyAnnotations(annotations) {
        //此处应获取附近的商户信息  121.498034  31.385146
        map.addAnnotations({
            annotations: annotations,
            icon: 'widget://image/companyusericon_128.jpg',
            draggable: false
        }, function(ret) {
            if (ret) {
                //当商户标注被点击的时候
                if (ret.eventType == "click") {
                    //获取被点击标注对应的商户编号
                    var company_no;
                    //遍历数组找到与当前点击对应的id相同的商户编号
                    for (var i = 0; i < g_CompanyList.length; i++) {
                        if (g_CompanyList[i].id == ret.id) {
                            company_no = g_CompanyList[i].company_no;
                        }
                    }
                    //发送滚动附近商户列表的事件
                    api.sendEvent({
                        name: 'CompanyInfoScrollEventListener',
                        extra: {
                            id: company_no
                        }
                    });
                }
            }
        });
    }
    //百度地图设置所有待接单订单标注信息
    function setPendingOrderAnnotations(annotations) {
        map.addAnnotations({
            annotations: annotations,
            icon: 'widget://image/help_64.png',
            draggable: false
        }, function(ret) {
            if (ret) {
                //当待接单订单标注被点击的时候
                if (ret.eventType == "click") {
                    //获取被点击标注对应的订单编号
                    var order_no;
                    //遍历数组找到与当前点击对应的id相同的订单编号
                    for (var i = 0; i < g_PendingOrderList.length; i++) {
                        if (g_PendingOrderList[i].id == ret.id) {
                            order_no = g_PendingOrderList[i].order_no;
                        }
                    }
                    //发送滚动待接单订单列表的事件
                    g_selected_pending_order_no = order_no;
                    api.sendEvent({
                        name: 'PendingOrderScrollEvent',
                        extra: {
                            id: order_no
                        }
                    });
                }
            }
        });
    }
    //设置商户标注弹出气泡
    function setCompanyBubble(bubble_id, company_name) {
        map.setBubble({
            id: bubble_id,
            content: {
                title: company_name,
                subTitle: company_name,
            },
            styles: {
                titleColor: '#000',
                titleSize: 16,
                subTitleColor: '#61c721',
                subTitleSize: 12,
                illusAlign: 'left'
            }
        }, function(ret) {
        });
    }
    //设置未接单订单标注弹出气泡
    function setPendingOrderBubble(bubble_id, service_type_name, failure_type_name, address) {
        map.setBubble({
            id: bubble_id,
            content:{
                title: failure_type_name,
                subTitle: address,
            },
            styles: {
                titleColor: '#000',
                titleSize: 16,
                subTitleColor: '#61c721',
                subTitleSize: 12,
                illusAlign: 'left'
            }
        }, function(ret) {
        });
    }
    //商户标注弹出气泡
    function popupCompanyBubble(company_no) {
        if (company_no != undefined) {
            map.popupBubble({
                id: company_no
            });
        }
    }
    //待接单标注弹出气泡
    function popupPendingOrderBubble(order_no) {
        if (order_no != undefined) {
            map.popupBubble({
                id: order_no
            });
        }
    }
    //打开定位按钮
    function openLocatingButton() {
        api.openFrame({
            name: 'locating_button',
            url: './html/frames/locating_button.html',
            rect: {
                x: 10,
                y: api.winHeight - 320,
                w: 30,
                h: 30
            },
            pageParam: {
            }
        });
        //设置定位按钮在遮罩层下面
        api.sendFrameToBack({
            from: 'locating_button',
            to: 'mask'
        });
    }
    //打开刷新按钮
    function openRefreshButton() {
        api.openFrame({
            name: 'refresh_button',
            url: './html/frames/refresh_button.html',
            rect: {
                x: 10,
                y: api.winHeight - 370,
                w: 30,
                h: 30
            },
            pageParam: {

            }
        });
        //设置刷新按钮在遮罩层下面
        api.sendFrameToBack({
            from: 'refresh_button',
            to: 'mask'
        });
    }
    //打开求救按钮
    function openSosButton() {
        api.openFrame({
            name: 'sos_button',
            url: './html/frames/sos_button.html',
            rect: {
                x: api.winWidth - 74,
                y: api.winHeight - 260,
                w: 64,
                h: 64
            },
            pageParam: {

            }
        });
        //设置求救按钮在遮罩层下面
        api.sendFrameToBack({
            from: 'sos_button',
            to: 'mask'
        });
    }
    //打开接单按钮
    function openReceiptButton() {
        api.openFrame({
            name: 'receipt_button',
            url: './html/frames/receipt_button.html',
            rect: {
                x: api.winWidth - 74,
                y: api.winHeight - 260,
                w: 64,
                h: 64
            },
            pageParam: {
            }
        });
        //设置接单按钮在遮罩层下面
        api.sendFrameToBack({
            from: 'receipt_button',
            to: 'mask'
        });
    }
    //打开附近商户信息frame
    function openCompanyFrame() {
        api.openFrame({
            name: 'nearby_company',
            url: './html/frames/nearby_company.html',
            rect: {
                x: 10,
                y: api.winHeight - 190,
                w: api.winWidth - 20,
                h: 180
            },
            reload: true,
            vScrollBarEnabled: false,
            pageParam: {
                g_my_lon: g_my_lon,
                g_my_lat: g_my_lat
            }
        });
        //打开定位和刷新按钮
        openLocatingButton();
        openSosButton();
        //设置附近商家Frame在遮罩层下面
        api.sendFrameToBack({
            from: 'nearby_company',
            to: 'mask'
        });
    }
    //打开待接单的订单信息frame
    function openPendingorderFrame() {
        //获取header高度
        var headerH = $('#header').get(0).offsetHeight;
        if (headerH == undefined)
            headerH = 80;
        api.openFrame({
            name: 'pending_order_list',
            url: './html/frames/pending_order_list.html',
            rect: {
                x: 10,
                y: headerH + 5,
                w: api.winWidth - 20,
                h: api.winHeight - (headerH + 15)
            },
            reload: true,
            vScrollBarEnabled: false,
            pageParam: {
                headerH: headerH,
                g_my_lon: g_my_lon,
                g_my_lat: g_my_lat,
                g_service_type_dict: g_service_type_dict,
                g_failure_type_dict: g_failure_type_dict
            }
        });
        //设置待接单订单Frame在遮罩层下面
        api.sendFrameToBack({
            from: 'pending_order_list',
            to: 'mask'
        });
    }
    //监听商户列表点击事件
    function registerCompanyListEvent() {
        api.addEventListener({
            name: 'ClickCompanyListEventListener'
        }, function(ret, err) {
            //弹出商户标注
            popupCompanyBubble(ret.value.company_no);
        });
    }
    //用户点击定位按钮事件
    function registLocatingEvent() {
        api.addEventListener({
            name: 'locatingEvent'
        }, function(ret, err) {
            //是否在地图上显示用户位置，会自动移动地图可视区域中心点到用户当前坐标位置
            map.showUserLocation({
                isShow: true,
                trackingMode: 'none'
            });
        });
    }
    //用户点击刷新按钮事件
    function registRefreshEvent() {
        api.addEventListener({
            name: 'refreshEvent'
        }, function(ret, err) {
            //从头再次执行
            getUserLocation();
        });
    }
    //注册根据经纬度设置百度地图中心点的事件(待接单列表点击的时候使用)
    function registerLocatingPersonUserLocationEvent() {
        api.addEventListener({
            name: 'LocatingPersonUserLocationEvent'
        }, function(ret, err) {
            //获取点击接单按钮时传过来的用坐标位置和订单编号
            var lon = ret.value.lon;
            var lat = ret.value.lat;
            var order_no = ret.value.order_no;
            //弹出待接单标注
            popupPendingOrderBubble(order_no);
            //根据经纬度设置百度地图中心点
            map.setCenter({
                coords: {
                    lon: lon,
                    lat: lat
                }
            });
        });
    }
    //注册根据经纬度设置百度地图中心点的事件(商户列表点击的时候使用)
    function registLocatingCompanyLocationEvent() {
        api.addEventListener({
            name: 'LocatingCompanyLocationEvent'
        }, function(ret, err) {
            var lon = ret.value.lon;
            var lat = ret.value.lat;
            var company_no = ret.value.company_no;
            map.setCenter({
                coords: {
                    lon: lon,
                    lat: lat
                }
            });
            //发送商户列表点击事件(滚动商户列表使用)
            api.sendEvent({
                name: 'ClickCompanyListEventListener',
                extra: {
                    company_no: company_no
                }
            });
        });
    }
    //接单点击事件
    function registerReceiptEvent() {
        api.addEventListener({
            name: 'receiptEvent'
        }, function(ret, err) {
            //判断接单编号是否为空
            var order_no=ret.value.order_no;
            if (order_no != undefined && order_no != "") {
                var s = 'http://' + serverIP + '/CompanyUser/CompanyUserAcceptPendingOrder.action';
                api.ajax({
                    url: s,
                    method: 'post',
                    timeout: 30,
                    dataType: 'json',
                    data: {
                        values: {
                            order_no: order_no
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                        if (ret.success) {
                            toastSuccess(ret.message);
                        } else {
                            toastFail(ret.message);
                            //如果用户已掉线
                            if (ret.relogin) {
                                api.sendEvent({
                                    name: 'reloginEvent'
                                });
                            }
                        }
                    } else {
                        toastFail("系统错误,接单失败!错误码:" + err.code);
                    }
                });
            } else {
                toastFail("请选择要接的单!");
            }
        });
    }
    //session不存在relogin事件
    function registerReloginEvent() {
        api.addEventListener({
            name: 'reloginEvent'
        }, function(ret, err) {
            //获取用户session
            getUserSession();
        });
    }
    //监听账户类型变化事件
    function registerChangeAccountTypeEvent() {
        api.addEventListener({
            name: 'ChangeAccountTypeEvent'
        }, function(ret, err) {
            //设置账户类型
            g_account_type = ret.value.account_type;
            //获取用户最新的订单状态
            getCurrentOrder();
        });
    }
    //获取订单状态
    function getOrderStatusInfo(order_no) {
        if (order_no == undefined || order_no == "") {
            return;
        }
        var s = 'http://' + serverIP + '/Order/getOrderMapByOrderNo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    order_no: order_no
                }
            }
        }, function(ret, err) {
            if (ret) {
                var order = undefined;
                var status_code, status_name, status_name_en;
                if ($.isArray(ret)) {
                    //获取正在进行中的订单
                    for (var i = 0; i < ret.length; i++) {
                        order = ret[0];
                    }
                    //获取订单的状态编号、中文名称、英文名称
                    if (order != undefined) {
                        status_code = order.status_code;
                        status_name = order.status_name;
                        status_name_en = order.status_name_en;
                    }
                    if (g_order_status != status_code) {
                        g_order_status = status_code;
                        //如果订单状态为已接单未付款
                        if (status_code == "confirmed") {
                            //如果是用户
                            if (g_account_type == "person_user") {
                                //获取商户编号
                                var company_no = order.company_no;
                                var ids = [];
                                //获取除了此订单之外的所有的商户编号集合
                                for (var i = 0; i < g_CompanyList.length; i++) {
                                    if (g_CompanyList[i].company_no == company_no) {
                                        continue;
                                    } else {
                                        ids.push(g_CompanyList[i].id);
                                    }
                                }
                                //移除所有在集合中标注
                                map.removeAnnotations({
                                    ids: ids
                                });
                            } else {//如果是商户
                                //获取订单编号
                                var order_no = order.order_no;
                                var ids = [];
                                //获取除了此订单之外的所有的订单编号集合
                                for (var i = 0; i < g_PendingOrderList.length; i++) {
                                    if (g_PendingOrderList[i].order_no == order_no) {
                                        continue;
                                    } else {
                                        ids.push(g_PendingOrderList[i].id);
                                    }
                                }
                                //移除所有在集合中标注
                                map.removeAnnotations({
                                    ids: ids
                                });
                            }
                        } else if (status_code == "pending") {
                          //如果订单状态为待接单
                        } else if (status_code == "confirmedpaid") {
                          //如果订单状态为已付款
                        } else if (status_code == "inservice") {
                          //如果订单状态为服务中
                        } else if (status_code == "finished") {
                          //如果订单状态为已完成
                        } else if (status_code == "cancelled") {
                          //如果订单状态为已取消
                        }
                    }
                    if (status_name != undefined && status_name != "") {
                        //打开定位按钮
                        openLocatingButton();
                        //打开订单状态窗体
                        openOrderStatusFrame(order);
                    }
                }
            } else {
                toastFail("系统错误,获取订单状态!错误码:" + err.code);
            }
        });
    }
    //获取当前订单的个人用户和商户用户当前位置，唯一同步地理信息的地方
    function getPersonUserAndCompanyUserCurrentLocation() {
        var s = 'http://' + serverIP + '/Order/getPersonUserAndCompanyUserCurrentLocation.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {}
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    //更新对方的位置，绘制路线
                    drawLocation(ret.accountType, ret.person_user_location, ret.company_user_location);
                } else {
                    toastFail(ret.msg);
                    if (ret.relogin) {
                        //session过期，重新登录 000
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail('系统错误,同步信息失败!错误码:' + err.code);
            }
        });
    }
    //画对方的位置
    function drawLocation(accountType, person_user_location, company_user_location) {
        //更新对方的位置, 此处改为定时更新客户位置信息
        if (accountType == "person_user") {//如果为普通用户
            if (company_user_location == undefined || company_user_location == "") {
                return;
            }
            //获取商户以","分割的字符串坐标
            var lon_lat = company_user_location.split(',');
            if (lon_lat.length > 1) {
                var lon = lon_lat[0];
                var lat = lon_lat[1];
                //更新商户位置
                updateCompanyUserAnnotation(g_CompanyList.length, lon, lat);
                //绘制路线
                drawRouteFromBeginToEnd(g_my_lon, g_my_lat, lon, lat);
            }
        } else if (accountType == "company_user") {//如果为商户
            if (person_user_location == undefined || person_user_location == "") {
                return;
            }
              //获取用户以","分割的字符串坐标
            var lon_lat = person_user_location.split(',');
            if (lon_lat.length > 1) {
                var lon = lon_lat[0];
                var lat = lon_lat[1];
                //更新用户位置
                updatePersonUserAnnotation(g_PendingOrderList.length, lon, lat);
                //绘制路线
                drawRouteFromBeginToEnd(g_my_lon, g_my_lat, lon, lat);
            }
        }
    }
    //上传坐标
    function SendLocationToServer(now_lon, now_lat, order_no, distanceToLastLocation) {
        //坐标组装
        var my_location = now_lon + "," + now_lat;
        var s = 'http://' + serverIP + '/Order/updateLocation.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    order_no: order_no,
                    my_location: my_location
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    //如果上次位置和本次位置距离大于10m
                    if (distanceToLastLocation > 10) {
                        //自动移动地图可视区域中心点到用户当前坐标位置
                        map.showUserLocation({
                            isShow: true,
                            trackingMode: 'none'
                        });
                    }
                    g_my_lon = now_lon;
                    g_my_lat = now_lat;
                }
            }
        });
    }

    //更新订单用户坐标
    function updateOrderUserLocation(order_no) {
        //如果订单编号为空,停止定位用户位置
        if (order_no == undefined) {
            map.stopLocation();
            return;
        }
        //获取用户位置
        map.getLocation({
            accuracy: '10m',
            autoStop: false,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                var now_lon = ret.lon;
                var now_lat = ret.lat;
                //获取上次和当前距离差，大于1m则更新位置
                if (g_my_lon != undefined && g_my_lat != undefined && now_lon != undefined && now_lat != undefined) {
                    //获取当前用户位置与上次位置的距离
                    map.getDistance({
                        start: {
                            lon: g_my_lon,
                            lat: g_my_lat
                        },
                        end: {
                            lon: now_lon,
                            lat: now_lat
                        }
                    }, function(ret) {
                        if (ret.status) {
                            SendLocationToServer(now_lon, now_lat, order_no, ret.distance);
                        }
                    });
                } else {
                    SendLocationToServer(now_lon, now_lat, order_no, 100);
                }
            } else {
                toastFail('获取用户信息时出错,错误信息:' + err.code);
            }
        });
    }
    //打开订单状态Frame
    function openOrderStatusFrame(order) {
        api.openFrame({
            name: 'order_status',
            url: './html/frames/order_status.html',
            rect: {
                x: 0,
                y: api.winHeight - 255,
                w: api.winWidth,
                h: 'auto',
                marginLeft: 10,
                marginBottom: 10,
                marginRight: 10
            },
            reload: true,
            vScrollBarEnabled: false,
            pageParam: {
                account_type: g_account_type,
                order: order
            }
        });
        //设置订单状态Frame在遮罩层下面
        api.sendFrameToBack({
            from: 'order_status',
            to: 'mask'
        });
    }
    //更新商户所派人员标注位置
    function updateCompanyUserAnnotation(id, lon, lat, title, subTitle) {
        //判断标注是否存在
        map.annotationExist({
            id: id
        }, function(ret) {
            if (ret.status) {
                //如果标注存在,修改标注所在位置
                map.setAnnotationCoords({
                    id: id,
                    lon: lon,
                    lat: lat
                });
            } else {
                //如果标注不存在,添加标注
                map.addAnnotations({
                    annotations: [{
                        id: id,
                        lon: lon,
                        lat: lat
                    }],
                    icon: 'widget://image/company_user_128.png',
                    draggable: false
                }, function(ret) {});
                //设置标注点击时弹出的信息
                map.setBubble({
                    id: id,
                    content: {
                        title: title,
                        subTitle: subTitle
                    },
                    styles: {
                        titleColor: '#000',
                        titleSize: 16,
                        subTitleColor: '#999',
                        subTitleSize: 12,
                        illusAlign: 'left'
                    }
                }, function(ret) {});
            }
        });
    }
    //更新用户标注位置
    function updatePersonUserAnnotation(id, lon, lat, title, subTitle) {
        //判断标注是否存在
        map.annotationExist({
            id: id
        }, function(ret) {
            if (ret.status) {
                //如果存在设置标注位置
                map.setAnnotationCoords({
                    id: id,
                    lon: lon,
                    lat: lat
                });
            } else {
                //如果不存在，先添加标注
                map.addAnnotations({
                    annotations: [{
                        id: id,
                        lon: lon,
                        lat: lat
                    }],
                    icon: 'widget://image/help_64.png',
                    draggable: false
                }, function(ret) {});
                //设置标注点击时弹出的信息
                map.setBubble({
                    id: id,
                    content: {
                        title: title,
                        subTitle: subTitle
                    },
                    styles: {
                        titleColor: '#000',
                        titleSize: 16,
                        subTitleColor: '#999',
                        subTitleSize: 12,
                        illusAlign: 'left'
                    }
                }, function(ret) {});
            }
        });

    }
    //获取用户session
    function getUserSession() {
        var s = 'http://' + serverIP + '/Login/getMySession.action';
        api.ajax({
            url: s,
            method: 'post'
        }, function(rets, err) {
            if (rets) {
                if (rets.success) {
                    //发送账户类型改变的事件
                    api.sendEvent({
                        name: 'ChangeAccountTypeEvent',
                        extra: {
                            account_type: rets.accountType
                        }
                    });
                    //设置头部账户类型信息
                    $('.aui-title').append("<i>" + rets.accountType + "<i>");
                    return;
                } else {
                    //获取账户信息
                    var data = getAccount();
                    try {
                        //如果不为空
                        if (data != undefined) {
                            var phone = account.username;
                            var password = account.password;
                            //用户自动登录
                            autoLoginWithCellPhoneNo(phone, password);
                            return;
                        } else {
                            //打开登录页面
                            openLogin();
                        }
                    } catch (e) {
                        toastFail('系统错误,请重新登录!');
                        openLogin();
                    }
                }
            } else {
                toastFail("系统错误,检测用户是否登录失败!错误码:" + err.code);
            }
        });
    }
    //自动登录事件,如果本地存在用户登录信息，则请求后台session或者刷新session
    function autoLoginWithCellPhoneNo(phone, password) {
        var s = 'http://' + serverIP + '/Login/LoginWithCellPhoneNo.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {
                    cellphoneno: phone,
                    password: password
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    //绑定推送
                    bindPush(phone);
                    var roles = ret.roles;
                    //加入现在的组
                    if (roles != undefined) {
                        var rolelist = roles.split(";");
                        for (i = 0; i < rolelist.length; i++) {
                            joinPushGroup(rolelist[i]);
                        }
                    }
                    var account = ret.account;
                    //清理本地缓存
                    clearStorage();
                    //设置账户信息到本地
                    $api.setStorage('g_account', account);
                    //设置连接融云聊天服务器的token信息
                    setToken();
                    //发送改变账户的事件
                    api.sendEvent({
                        name: 'ChangeAccountTypeEvent',
                        extra: {
                            account_type: ret.accountType
                        }
                    });
                } else {
                    toastFail(ret.msg);
                    openLogin();
                }
            } else {
                toastFail("系统错误,自动登录登录失败!错误码:" + err.code);
            }
        });
    }
    //获取用户最新的订单状态
    function getCurrentOrder() {
        //请求后台判断用户是否有正在进行的订单
        var s = 'http://' + serverIP + '/Order/getCurrentOrder.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(rets, err) {
            //清屏操作
            clearPanel();
            if (rets) {
                g_account_type = rets.accountType;
                var desc = "";
                if(g_account_type == "person_user"){
                  desc=GetTextByLanguage("普通用户","Person");
                }else if(g_account_type == "company_user"){
                  desc=GetTextByLanguage("商户","Company");
                }
                $('.item-account-type').text(desc);
                if (rets.success) {
                    //存在进行中订单,更新订单状态
                    updateOrderStatus(rets.order_no);
                } else {
                    //为了关闭定时器
                    updateOrderStatus(undefined);
                    if (rets.relogin) {
                        //session过期，重新登录 000
                        toastFail(rets.msg);
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    } else {
                        //不存在进行中订单
                        if (g_account_type == "person_user") {
                            //如果是个人用则显示附近商户
                            openCompanyFrame();
                        } else if (g_account_type == "company_user") {
                            //如果是商户用户,则显示所有pending订单
                            openPendingorderFrame();
                        } else {
                            toastFail("系统错误,未找到相应账户类型!");
                        }
                    }
                }
            } else {
                toastFail("系统错误,获取最新订单失败!错误码" + err.code);
            }
        });
    }
    //更新当前订单的状态
    function updateOrderStatus(order_no) {
        //清理定时器
        if (order_no == undefined && g_PersonUserAndCompanyUserLocationInterval != -1) {
            window.clearInterval(g_PersonUserAndCompanyUserLocationInterval);
            g_PersonUserAndCompanyUserLocationInterval = -1;
        }
        //获取订单状态
        getOrderStatusInfo(order_no);
        //更新订单用户坐标
        updateOrderUserLocation(order_no);
        if (order_no != undefined) {
            if (g_PersonUserAndCompanyUserLocationInterval == -1) {
                //开启更新用户和商户坐标的定时器
                g_PersonUserAndCompanyUserLocationInterval = window.setInterval(function() {
                    getPersonUserAndCompanyUserCurrentLocation();
                }, 5000);
            }
        }
    }
    //注册停止更新用户和商户的坐标事件(退出登录的时候调用)
    function registerStopUpdateUserLocation(){
      api.addEventListener({
          name: 'StopUpdateUserLocationEvent'
      }, function(ret, err) {
           //清理定时更新
           window.clearInterval(g_PersonUserAndCompanyUserLocationInterval);
           //关闭百度地图
           map.close();
      });
    }
    //注册加载附近商户的信息事件
    function registerLoadNearbyCompanyEvent() {
        api.addEventListener({
            name: 'loadNearbyCompanyEvent'
        }, function(ret, err) {
            var annotations = ret.value.annotations;
            var companyList = ret.value.g_companyList;
            var bubble = ret.value.bubble;
            //设置全局商户信息列表
            g_CompanyList = companyList;
            //设置商户的标注信息
            setCompanyAnnotations(annotations);
            //设置商户标注点击时弹出的内容
            for (var i = 0; i < bubble.length; i++) {
                setCompanyBubble(bubble[i].id, bubble[i].company_name);
            }
        });
    }
    //注册加载所有未接单的订单事件
    function registerSetPendingOrderAnnotationsEvent() {
        api.addEventListener({
            name: 'setPendingOrderAnnotationsEvent'
        }, function(ret, err) {
            var annotations = ret.value.annotations;
            var orderList = ret.value.g_PendingOrderList;
            var bubble = ret.value.bubble;
              //设置全局待接单信息列表
            g_PendingOrderList = orderList;
              //设置待接单的标注信息
            setPendingOrderAnnotations(annotations);
            //设置待接单标注点击时弹出的内容
            for (var i = 0; i < bubble.length; i++) {
                setPendingOrderBubble(bubble[i].id, bubble[i].service_type_name, bubble[i].failure_type_name, bubble[i].address);
            }
        });
    }
    //账户类型切换事件
    function requestSwitchAccounType(account_type) {
        //向后台发出请求判断是否能够切换
        var s = 'http://' + serverIP + '/Login/APPSwitchAccoutType.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {
                    ToAccountType: account_type
                }
            }
        }, function(rets, err) {
            if (rets) {
                if (rets.success) {
                    toastSuccess(rets.msg);
                    //发送账户类型改变的事件
                    api.sendEvent({
                        name: 'ChangeAccountTypeEvent',
                        extra: {
                            account_type: account_type
                        }
                    });
                } else {
                    toastFail(rets.msg);
                    if (rets.relogin) {
                        //session过期，重新登录 000
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,切换账户失败!错误码:" + err.code);
            }
        });
    }
    //打开对话窗体
    function openConversation() {
        //隐藏消息通知的红点
        $('.message-dot').hide();
        api.openWin({
            name: 'conversation',
            url: './html/message/conversation.html',
            reload: true,
            pageParam: {}
        });
    }
    //清屏
    function clearPanel() {
        var company_ids = [],pending_order_ids=[];
        //获取所有的商户信息数组
        for (var i = 0; i < g_CompanyList.length; i++) {
            company_ids.push(g_CompanyList[i].id);
        }
        //获取所有的待接单信息数组
        for (var i = 0; i < g_PendingOrderList.length; i++) {
            pending_order_ids.push(g_PendingOrderList[i].id);
        }
        company_ids.push(g_CompanyList.length);
        pending_order_ids.push(g_PendingOrderList.length);
        //移除商户信息标注
        map.removeAnnotations({
            ids: company_ids
        });
        //移除待接单信息标注
        map.removeAnnotations({
            ids: pending_order_ids
        });
        //移除标注弹出框
        map.removeRoute({
            company_ids: [1]
        });
        map.removeRoute({
            pending_order_ids: [1]
        });
        g_CompanyList.length = 0;
        g_PendingOrderList.length=0;
        //关闭打开的窗体
        api.closeFrame({
            name: 'nearby_company'
        });
        api.closeFrame({
            name: 'sos_button'
        });
        api.closeFrame({
            name: 'pending_order_list'
        });
        api.closeFrame({
            name: 'pending_order'
        });
        api.closeFrame({
            name: 'order_status'
        });
        api.closeFrame({
            name: 'service_type'
        });
    }
    //注册加载所有服务类型事件
    function registerLoadAllServiceTypeEvent() {
        api.addEventListener({
            name: 'GetAllServiceTypeEvent'
        }, function(ret, err) {
            try {
                if (ret) {
                    g_service_type_dict = ret.value.g_service_type_dict;
                }
            } catch (e) {
                toastFail("系统错误,解析服务类型异常!");
            }
        });
    }
    //注册加载所有故障类型事件
    function registerLoadAllFaultTypeEvent() {
        api.addEventListener({
            name: 'GetAllFailureTypeEvent'
        }, function(ret, err) {
            try {
                if (ret) {
                    g_failure_type_dict = ret.value.g_failure_type_dict;
                }
            } catch (e) {
                toastFail("系统错误,解析故障类型异常!");
            }
        });
    }
    //设置推送回调函数
    function setPushListener() {
        var push = api.require('push');
        push.setListener(function(ret, err) {
            if (ret) {
                if (ret.data) {
                    try {
                        var jsonObject = JSON.parse(ret.data);
                        if (jsonObject.success) {
                            var order_no = jsonObject.OrderNo;
                            getCurrentOrder();
                        }
                    } catch (e) {
                        toastFail('推送异常!');
                    }
                }
            } else {
                api.alert({
                    msg: err
                });
            }
        });
    }
    //绘制两点之间路线
    function drawRouteFromBeginToEnd(begin_lon, begin_lat, end_lon, end_lat) {
        //如果起始点和终点坐标部位空
        if (begin_lon != undefined && begin_lat != undefined && end_lon != undefined && end_lat != undefined) {
            //先移除已经存在的路线
            map.removeRoute({
                ids: [1]
            });
            //搜索路线
            map.searchRoute({
                id: 1,
                type: 'drive',
                policy: 'ecar_time_first/ecar_dis_first',
                start: {
                    lon: begin_lon,
                    lat: begin_lat
                },
                end: {
                    lon: end_lon,
                    lat: end_lat
                }
            }, function(ret, err) {
                if (ret.status) {
                    //绘制路线
                    map.drawRoute({
                        id: 1,
                        autoresizing: false,
                        index: 0
                    }, function(ret) {

                    });
                }
            });
        }
    }
    //侧滑打开账户设置
    function openAccount() {
        //打开遮罩层
        api.openFrame({
            name: 'mask',
            url: './html/frames/mask.html',
            reload: true,
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth,
                h: api.height
            }
        });
        //打开账户设置页面
        api.openFrame({
            name: 'account',
            url: './html/frames/account.html',
            reload: true,
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth - api.winWidth / 3,
                h: api.height
            },
            animation: {
                type: "movein",
                subType: "from_left",
                duration: 300
            },
            pageParam: {
                account_type: g_account_type
            }
        });
    }
    //监听遮罩层点击事件
    function registerMaskEvent() {
        api.addEventListener({
            name: 'MaskClickEvent'
        }, function(ret, err) {
            //关闭遮罩层和账户设置页面
            closeMaskAndAccountFrame();
        });
    }
    //关闭侧滑Frame
    function closeMaskAndAccountFrame() {
        api.closeFrame({
            name: 'mask'
        });
        api.closeFrame({
            name: 'account'
        });
    }
    //监听账户切换事件
    function registerSwitchAccountTypeEvent() {
        api.addEventListener({
            name: 'SwitchAccountTypeEvent'
        }, function(ret, err) {
            if (ret) {
                 //关闭遮罩层和账户设置页面
                 closeMaskAndAccountFrame();
                 //账户类型切换
                 requestSwitchAccounType(ret.value.account_type);
            }
        });
    }
    //初始化融云聊天服务器
    function initRong() {
        rong.init(function(ret, err) {
            if (ret.status == 'success') {
                //消息监听
                registerReceiveMessageListener();
                //连接融云聊天服务器
                rong.connect({
                    token: $api.getStorage('token')
                }, function(ret, err) {});
            } else {
                toastFail("系统错误,连接聊天服务器异常!");
            }
        });
    }
    //设置消息监听
    function registerReceiveMessageListener() {
        //开始消息监听
        rong.setOnReceiveMessageListener(function(ret, err) {
            if (ret) {
                //显示消息通知的红点
                $('.message-dot').show();
                //发送更新会话列表命令
                api.sendEvent({
                    name: 'UpdateConversationListEvent'
                });
                //发送最新消息命令
                api.sendEvent({
                    name: 'NewMsgEvent',
                    extra: {
                        msg: ret.result.message
                    }
                })
            }
        })
    }
    //打开登录页面
    function openLogin(){
      api.openWin({
          name: 'login',
          url: './html/login/login.html',
          reload: true,
          pageParam: {}
      });
    }
</script>

</html>
