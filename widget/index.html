<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css" />
    <link rel="stylesheet" type="text/css" href="./css/aui.css" />
    <link rel="stylesheet" href="./css/font-awesome.min.css" />
    <style type="text/css">
        #header {
            background-color: #61C721;
            padding-top: 50px;
        }

        .wrap {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-flex-flow: column;
        }

        header {
            height: 60px;
            width: 100%;
            text-align: center;
            background-color: #81a9c3;
            color: #fff;
            line-height: 44px;
            font-size: 20px;
        }

        .flex-1 {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
        }

        footer {
            height: 30px;
            width: 100%;
            background-color: #81a9c3;
            color: white;
            line-height: 30px;
            text-align: center;
        }

        .poilist-container {
            position: absolute;
            bottom: 4px;
            width: 100%;
            height: 200px;
            z-index: 9999999;
            background-color: red;
        }

        .poilist-ul li {
            padding: 5px 0px;
            border-bottom: 1px solid #000;
        }

        .fa-size {
            font-size: 1.2rem;
        }
    </style>
</head>

<body class="wrap">
    <header id="header" class="aui-bar aui-bar-nav">
        <a class="aui-pull-left aui-btn">
            <i class="fa fa-user-circle-o fa-size" onclick="changeAccounType('person_user');"></i>
        </a>
        <div class="aui-title">
            <i class="fa fa-user fa-size" onclick="changeAccounType('company_user');"></i>
        </div>
        <a class="aui-pull-right aui-btn">
            <i class="fa fa-commenting fa-2x fa-size" onclick="accountMessage();"></i>
        </a>
    </header>
    <section class="flex-1">

    </section>
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="./script/common.js"></script>
<script type="text/javascript">
    var g_my_lon, g_my_lat, g_company_lon, g_company_lat;
    var map;
    var g_status = "idle";
    var g_service_type = false;
    var g_orderStatusInterval, g_userLocationInterval;
    var g_CU = [];
    var g_order_status = "";
    var g_account_type = "person_user";
    var g_pending_order_no;
    apiready = function() {
        fnSettingHeader();
        getUserSession();
        map = api.require('bMap');
        registLocatingEvent();

        registerSosEvent();
        registerOrderStatusEvent();
        registerCancelOrderEvent();
        registerCompanyListEvent();

        registerReceiptEvent();
        registerPendingOrderListEvent();

        initMapSDK();

    };
    //1.初始化MapSDK
    function initMapSDK() {
        if (api.systemType == "ios") {
            map.initMapSDK(function(ret) {
                if (ret.status) {
                    openbMap();
                } else {
                    alert('地图初始化失败，无法使用定位！');
                }
            });
        } else {
            openbMap();
        }
    }
    //2.初始化成功打开Map
    function openbMap() {
        map.open({
            rect: {
                x: 0,
                y: 70,
                w: api.winWidth,
                h: api.winHeight
            },
            center: {
                lon: 121.377462,
                lat: 31.47022
            },
            zoomLevel: 17,
            showUserLocation: true
        }, function(ret) {
            if (ret.status) {
                setTimeout(function() {
                    showUserLocation();
                }, 100);
                setTimeout(function() {
                    getLocationServices();
                }, 200);
            } else {
                alert('地图打开失败，无法使用定位！');
            }
        });

    }
    //3.设置是否显示用户位置
    function showUserLocation() {
        map.showUserLocation({
            isShow: true,
            trackingMode: 'none'
        });
    }
    //4.判断用户是否开启定位服务
    function getLocationServices() {
        map.getLocationServices(function(ret, err) {
            if (ret.enable) {
                getUserLocation();

            } else {
                alert("未开启定位功能！");
            }
        });
    }
    //5.获取用户位置信息
    function getUserLocation() {
        map.getLocation({
            accuracy: '10m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                g_my_lon = ret.lon;
                g_my_lat = ret.lat;
                initMapSDKOK();
            } else {
                alert('获取用户信息时出错,错误信息:' + err.code);
                map.stopLocation();
            }
        });
    }
    //初始化地图成功,获取最新订单信息
    function initMapSDKOK() {
        getCurrentOrder(g_account_type);
    }
    //设置商户标注信息
    function setCompanyAnnotations(annotations) {
        //此处应获取附近的商户信息  121.498034  31.385146
        map.addAnnotations({
            annotations: annotations,
            icon: 'widget://image/companyusericon_128.jpg',
            draggable: false
        }, function(ret) {
            if (ret) {
                if (ret.eventType == "click") {
                    var company_user_no;
                    for (var i = 0; i < g_CU.length; i++) {
                        if (g_CU[i].id == ret.id) {
                            company_user_no = g_CU[i].company_user_no;
                        }
                    }
                    api.sendEvent({
                        name: 'CompanyInfoScrollEventListener',
                        extra: {
                            id: company_user_no
                        }
                    });
                }
            }
        });
    }
    //设置所有待接单订单标注信息
    function setPendingOrderAnnotations(annotations) {
        map.addAnnotations({
            annotations: annotations,
            icon: 'widget://image/help_64.png',
            draggable: false
        }, function(ret) {
            if (ret) {
                if (ret.eventType == "click") {
                    var order_no;
                    for (var i = 0; i < g_CU.length; i++) {
                        if (g_CU[i].id == ret.id) {
                            order_no = g_CU[i].order_no;
                        }
                    }
                    g_pending_order_no = order_no;
                    api.sendEvent({
                        name: 'PendingOrderScrollEvent',
                        extra: {
                            id: order_no
                        }
                    });
                }
            }
        });
    }
    //设置商户标注弹出气泡
    function setCompanyBubble(bubble_id, company_name) {
        map.setBubble({
            id: bubble_id,
            // bgImg: 'widget://image/bubble_bg.png',
            content: {
                title: company_name,
                subTitle: company_name,
            },
            styles: {
                titleColor: '#000',
                titleSize: 16,
                subTitleColor: '#61c721',
                subTitleSize: 12,
                illusAlign: 'left'
            }
        }, function(ret) {
            // if (ret) {
            //     alert(ret.eventType);
            // }
        });
    }
    //设置未接单订单标注弹出气泡
    function setPendingOrderBubble(bubble_id, service_type_name, failure_type_name) {
        map.setBubble({
            id: bubble_id,
            // bgImg: 'widget://image/bubble_bg.png',
            content: {
                title: service_type_name,
                subTitle: failure_type_name,
            },
            styles: {
                titleColor: '#000',
                titleSize: 16,
                subTitleColor: '#61c721',
                subTitleSize: 12,
                illusAlign: 'left'
            }
        }, function(ret) {
            // if (ret) {
            //     alert(ret.eventType);
            // }
        });
    }
    //商户标注弹出气泡
    function popupCompanyBubble(company_no) {
        for (var i = 0; i < g_CU.length; i++) {
            if (g_CU[i].company_user_no == company_no) {
                company_no = g_CU[i].id;
            }
        }
        if (company_no != undefined) {
            map.popupBubble({
                id: company_no
            });
        }
    }
    //待接单标注弹出气泡
    function popupPendingOrderBubble(company_no) {
        for (var i = 0; i < g_CU.length; i++) {
            if (g_CU[i].company_user_no == company_no) {
                company_no = g_CU[i].id;
            }
        }
        if (company_no != undefined) {
            map.popupBubble({
                id: company_no
            });
        }
    }
    //打开定位按钮
    function openLocatingButton() {
        api.openFrame({
            name: 'locating_button',
            url: './html/frames/locating_button.html',
            rect: {
                x: 10,
                y: api.winHeight - 250,
                w: 30,
                h: 30
            },
            pageParam: {

            }
        });
    }
    //打开求救按钮
    function openSosButton() {
        api.openFrame({
            name: 'sos_button',
            url: './html/frames/sos_button.html',
            rect: {
                x: api.winWidth - 74,
                y: api.winHeight - 260,
                w: 64,
                h: 64
            },
            pageParam: {

            }
        });
    }
    //打开接单按钮
    function openReceiptButton() {
        api.openFrame({
            name: 'receipt_button',
            url: './html/frames/receipt_button.html',
            rect: {
                x: api.winWidth - 74,
                y: api.winHeight - 260,
                w: 64,
                h: 64
            },
            pageParam: {

            }
        });
    }
    //打开附近商户信息frame
    function openCompanyFrame(rets) {
        api.openFrame({
            name: 'nearby_company',
            url: './html/frames/nearby_company.html',
            rect: {
                x: 10,
                y: api.winHeight - 190,
                w: api.winWidth - 20,
                h: 180
            },
            vScrollBarEnabled: false,
            pageParam: {
                company: rets
            }
        });
    }
    //打开待接单的订单信息frame
    function openPendingorderFrame(rets) {
        api.openFrame({
            name: 'pending_order',
            url: './html/frames/pending_order.html',
            rect: {
                x: 10,
                y: api.winHeight - 190,
                w: api.winWidth - 20,
                h: 180
            },
            vScrollBarEnabled: false,
            pageParam: {
                pendingorder: rets
            }
        });
    }
    //监听商户列表点击事件
    function registerCompanyListEvent() {
        api.addEventListener({
            name: 'ClickCompanyListEventListener'
        }, function(ret, err) {
            popupCompanyBubble(ret.value.company_no);
        });
    }
    //监听待接单列表点击事件
    function registerPendingOrderListEvent() {
        api.addEventListener({
            name: 'ClickPendingOrderListEventListener'
        }, function(ret, err) {
            g_pending_order_no = ret.value.company_no;
            popupPendingOrderBubble(ret.value.company_no);
        });
    }
    //设置用户位置
    function registLocatingEvent() {
        api.addEventListener({
            name: 'locatingEvent'
        }, function(ret, err) {
            map.showUserLocation({
                isShow: true,
                trackingMode: 'none'
            });
        });
    }
    //求救点击事件
    function registerSosEvent() {
        api.addEventListener({
            name: 'sosEvent'
        }, function(ret, err) {
            g_status = ""; //设置状态
            //打开服务类型
            api.openFrame({
                name: 'service_type',
                url: './html/frames/service_type.html',
                rect: {
                    x: 10,
                    y: 80,
                    w: api.winWidth - 20,
                    h: api.winHeight - 90
                },
                reload: true,
                animation: {
                    type: "push",
                    subType: "from_bottom",
                    duration: 200
                }
            });
        });
    }
    //接单点击事件
    function registerReceiptEvent() {
        api.addEventListener({
            name: 'receiptEvent'
        }, function(ret, err) {
            //判断是否选中了要接的单,如果选中了接单获取接单编号
            if (g_pending_order_no != undefined && g_pending_order_no != "") {
                alert("点击了接单，开始接单后操作");
            } else {
                toastFail("请选择后接单!");
            }
        });
    }
    //监听生成订单后事件
    function registerOrderStatusEvent() {
        api.addEventListener({
            name: 'OrderStatusEvent'
        }, function(ret, err) {
            if (ret.value.order_no != undefined) {
                //关闭附近商户列表和求救Frame
                updateOrderStatus(ret.value.order_no);
                // api.closeFrame({
                //     name: 'nearby_company'
                // });
                // api.closeFrame({
                //     name: 'help_button'
                // });
                // var order_no = ret.value.order_no;
                // openOrderStatusFrame();
                // //开始定时器，定时更新订单状态和用户坐标
                // var g_orderStatusInterval = setInterval(function() {
                //     getOrderStatusInfo(order_no);
                // }, 3000);
                // var g_userLocationInterval = setInterval(function() {
                //     updateOrderUserLocation(order_no);
                // }, 5000);
            } else {
                api.alert({
                    msg: "服务器繁忙,请刷新重试!"
                });
            }
        });
    }
    //取消订单事件
    function registerCancelOrderEvent() {
        api.addEventListener({
            name: 'CancelOrderEvent'
        }, function(ret, err) {
            //关闭订单frame
            //打开附近商户frame和求救frame
        });
    }
    //获取订单状态
    function getOrderStatusInfo(order_no) {
        if (order_no == undefined || order_no == "") {
            return;
        }
        var s = 'http://' + serverIP + '/Order/getOrderByOrderNo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    order_no: order_no
                }
            }
        }, function(ret, err) {
            if (ret) {
                var order;
                var status_code, status_name, status_name_en, company_user_location,person_user_location;
                if ($.isArray(ret)) {
                    for (var i = 0; i < ret.length; i++) {
                        order = ret[0];
                    }
                    if (order != undefined) {
                        status_code = order.status_code;
                        status_name = order.status_name;
                        status_name_en = order.status_name_en;
                        company_user_location = order.company_user_location;
                        person_user_location=order.person_user_location;
                    }
                    //获取商户坐标
                    if (company_user_location != undefined) {
                        var lon_lat = company_user_location.split(',');
                        if (lon_lat.length > 1) {
                            var lon = lon_lat[0];
                            var lat = lon_lat[1];
                            updateCompanyUserLocation(g_CU.length, lon, lat);
                        }
                    }
                    //获取用户坐标
                    if(person_user_location!=undefined){
                      var lon_lat = person_user_location.split(',');
                      if (lon_lat.length > 1) {
                          var lon = lon_lat[0];
                          var lat = lon_lat[1];
                          updatePersonUserLocation(g_CU.length+1, lon, lat);
                          //updateCompanyUserLocation(g_CU.length, lon, lat);
                      }
                    }
                    if (g_order_status != status_code) {
                        g_order_status = status_code;
                        if (status_code == "confirmed") {
                            //updateCompanyUserLocation(company_user_location);
                            //如果是用户
                            var company_user_no = order.company_user_no;
                            var ids = [];
                            for (var i = 0; i < g_CU.length; i++) {
                                if (g_CU[i].company_user_no == company_user_no) {
                                    continue;
                                } else {
                                    ids.push(g_CU[i].id);
                                }
                            }
                            map.removeAnnotations({
                                ids: ids
                            });
                            //如果是商户
                        } else if (status_code == "pending") {

                        } else if (status_code == "paid") {

                        } else if (status_code == "inservice") {

                        } else if (status_code == "finished") {
                            getCurrentOrder(g_account_type);
                        } else if (status_code == "cancelled") {
                            getCurrentOrder(g_account_type);
                        }
                    }
                    if (status_name != undefined && status_name != "") {
                        api.sendEvent({
                            name: 'UpdateOrderStatusEvent',
                            extra: {
                                status_name: status_name
                            }
                        });
                    }
                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
                clearInterval(g_orderStatusInterval);
            }
        });
    }
    //更新订单用户坐标
    function updateOrderUserLocation(order_no) {
        map.getCurrentLocation(
            function(ret, err) {
                if (ret.status) {
                    var now_lon = ret.lon;
                    var now_lat = ret.lat;
                    //获取上次和当前距离差，大于1m则更新位置
                    if (g_my_lon != undefined && g_my_lat != undefined && now_lon != undefined && now_lat != undefined) {
                        map.getDistance({
                            start: {
                                lon: g_my_lon,
                                lat: g_my_lat
                            },
                            end: {
                                lon: now_lon,
                                lat: now_lat
                            }
                        }, function(ret) {
                            if (ret.status) {
                                var distance = ret.distance;
                                if (distance != undefined && distance > 10) {
                                    g_my_lon = now_lon;
                                    g_my_lat = now_lat;
                                    var person_user_location = now_lon + "," + now_lat;
                                    var s = 'http://' + serverIP + '/Order/updateLocation.action';
                                    api.ajax({
                                        url: s,
                                        method: 'post',
                                        timeout: 30,
                                        dataType: 'json',
                                        data: {
                                            values: {
                                                order_no: order_no,
                                                person_user_location: person_user_location
                                            }
                                        }
                                    }, function(ret, err) {});
                                }
                            }
                        });
                    }
                } else {}
            });
    }
    //打开订单状态Frame
    function openOrderStatusFrame(order_status) {
        api.openFrame({
            name: 'order_status',
            url: './html/frames/order_status.html',
            rect: {
                x: 10,
                y: api.winHeight - 100,
                w: api.winWidth - 20,
                h: 90
            },
            bgColor: 'transparent',
            vScrollBarEnabled: false,
            pageParam: {}
        });
    }
    //更新商户所派人员坐标
    function updateCompanyUserLocation(id, lon, lat) {
        map.annotationExist({
            id: id
        }, function(ret) {
            if (ret.status) {
                map.setAnnotationCoords({
                    id: id,
                    lon: lon,
                    lat: lat
                });
            } else {
                map.addAnnotations({
                    annotations: [{
                        id: id,
                        lon: lon,
                        lat: lat
                    }],
                    icon: 'widget://image/company_user_128.png',
                    draggable: false
                }, function(ret) {});
            }
        });

    }
    //更新用户坐标
    function updatePersonUserLocation(id, lon, lat) {
        map.annotationExist({
            id: id
        }, function(ret) {
            if (ret.status) {
                map.setAnnotationCoords({
                    id: id,
                    lon: lon,
                    lat: lat
                });
            } else {
                map.addAnnotations({
                    annotations: [{
                        id: id,
                        lon: lon,
                        lat: lat
                    }],
                    icon: 'widget://image/help_64.png',
                    draggable: false
                }, function(ret) {});
            }
        });

    }
    //获取用户session
    function getUserSession() {
        var s = 'http://' + serverIP + '/Login/getMySession.action';
        api.ajax({
            url: s,
            method: 'post'
        }, function(rets, errs) {
            if (rets) {
                if (rets.success) {
                    return;
                }
                if (!rets.success) {
                    var data = api.getPrefs({
                        sync: true,
                        key: 'userInfo'
                    });
                    if (data != undefined && data != "") {
                        var userInfo = JSON.parse(data);
                        var phone = userInfo.phone;
                        var password = userInfo.password;
                        autoLoginWithCellPhoneNo(phone, password);
                        return;
                    }
                }
                api.openWin({
                    name: 'login',
                    url: './html/login/login.html',
                    reload: true,
                    pageParam: {}
                });

            } else {
                toastFail("登录异常,请稍后重试!");
            }
        });
    }
    //如果本地存在用户登录信息，则请求后台session或者刷新session
    function autoLoginWithCellPhoneNo(phone, password) {
        var s = 'http://' + serverIP + '/Login/LoginWithCellPhoneNo.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {
                    cellphoneno: phone,
                    password: password
                }
            }
        }, function(rets, errs) {
            if (rets) {
                if (rets.success) {
                    alert("自动登录成功!");
                } else {
                    toastFail(rets.msg);
                    api.openWin({
                        name: 'login',
                        url: './html/login/login.html',
                        reload: true,
                        pageParam: {}
                    });
                }
            } else {
                toastFail("登录异常,请稍后重试!");
            }
        });
    }
    //获取用户最新的订单状态
    function getCurrentOrder(usertype) {
        //请求后台判断用户是否有正在进行的订单
        var s = 'http://' + serverIP + '/Order/getCurrentOrder.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {
                    usertype: usertype
                }
            }
        }, function(rets, errs) {
            //清屏操作
            clearPanel();
            if (rets) {
                if (rets.success) {
                    //存在进行中订单
                    updateOrderStatus(rets.order_no);
                } else {
                    //不存在进行中订单
                    if (g_account_type == "person_user") {
                        //如果是个人用则显示附近商户
                        loadNearbyCompany();
                    } else {
                        //如果是商户用户,则显示所有pending订单
                        loadAllPendingOrder();
                    }
                }
            } else {
                toastFail("getCurrentOrder异常,请稍后重试!");
            }
        });
    }
    //更新当前订单的状态
    function updateOrderStatus(order_no) {
        //关闭附近商户列表和求救Frame
        clearInterval(g_orderStatusInterval);
        clearInterval(g_userLocationInterval);
        if (order_no != undefined && order_no != "") {
            api.closeFrame({
                name: 'nearby_company'
            });
            api.closeFrame({
                name: 'sos_button'
            });
            api.closeFrame({
                name: 'pending_order'
            });
            api.closeFrame({
                name: 'receipt_button'
            });
            openOrderStatusFrame();
            //开始定时器，定时更新订单状态和用户坐标
            g_orderStatusInterval = setInterval(function() {
                getOrderStatusInfo(order_no);
            }, 3000);
            g_userLocationInterval = setInterval(function() {
                updateOrderUserLocation(order_no);
            }, 5000);
        }
    }

    //加载附近商户的信息
    function loadNearbyCompany() {
        if (g_my_lon != undefined && g_my_lat != undefined) {
            var s = 'http://' + serverIP + '/PersonUser/getNearByCompanyUser.action';
            api.ajax({
                url: s,
                method: 'post',
                data: {
                    values: {
                        lon: g_my_lon,
                        lat: g_my_lat
                    }
                }
            }, function(rets, errs) {
                if (rets) {
                    // rets=[
                    //   {"service_type_name":"现场服务","distance":5.821319323997567,"company_user_no":"CU00001","failure_type_name":"轮胎故障,引擎故障","id":1},
                    //   {"service_type_name":"门店服务","distance":780.99282824995,"company_user_no":"CU00008","failure_type_name":"轮胎故障,引擎故障,水箱故障","id":9},
                    //   {"service_type_name":"拖车服务","distance":1013.8431967008512,"company_user_no":"CU00007","failure_type_name":"轮胎故障,引擎故障","id":8}];
                    var annotations = [];
                    g_CU.length = 0;
                    for (var i = 0; i < rets.length; i++) {
                        var temp = {
                            "id": i,
                            "lon": rets[i].company_location_lon,
                            "lat": rets[i].company_location_lat
                        };
                        annotations.push(temp);
                        g_CU.push({
                            id: i,
                            company_user_no: rets[i].company_user_no
                        });
                    }
                    setCompanyAnnotations(annotations);
                    for (var i = 0; i < rets.length; i++) {
                        setCompanyBubble(i, rets[i].company_name);
                    }
                    openCompanyFrame(rets);
                    openLocatingButton();
                    openSosButton();
                    // openPendingorderFrame(rets);
                    // openLocatingButton();
                    // openReceiptButton();
                } else {
                    api.alert({
                        msg: errs.msg
                    });
                    // openCompanyFrame(rets);
                    // openLocatingButton();
                    // openSosButton();
                }
            });
        }
    }
    //加载所有未接单的订单
    function loadAllPendingOrder() {
        if (g_my_lon != undefined && g_my_lat != undefined) {
            var s = 'http://' + serverIP + '/PersonUser/getNearByCompanyUser.action';
            api.ajax({
                url: s,
                method: 'post',
                data: {
                    values: {
                        lon: g_my_lon,
                        lat: g_my_lat
                    }
                }
            }, function(rets, errs) {
                if (rets) {
                    var annotations = [];
                    g_CU.length = 0;
                    for (var i = 0; i < rets.length; i++) {
                        var temp = {
                            "id": i,
                            "lon": rets[i].company_location_lon,
                            "lat": rets[i].company_location_lat
                        };
                        annotations.push(temp);
                        //g_CU.push(rets[i].company_user_no);
                        g_CU.push({
                            id: i,
                            order_no: rets[i].order_no
                        });
                    }
                    setPendingOrderAnnotations(annotations);
                    for (var i = 0; i < rets.length; i++) {
                        setPendingOrderBubble(i, rets[i].service_type_name, rets[i].failure_type_name);
                    }
                    openPendingorderFrame(rets);
                    openLocatingButton();
                    openReceiptButton();
                } else {
                    api.alert({
                        msg: errs.msg
                    });
                    // openPendingorderFrame(rets);
                    // openLocatingButton();
                    // openReceiptButton();
                }
            });
        }
    }
    //切换至普通账户
    function changeAccounType(account_type) {
        alert('请求切换至' + account_type);
        //向后台发出请求判断是否能够切换
        var s = 'http://' + serverIP + '/Login/APPSwitchAccoutType.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {
                    ToAccountType: account_type
                }
            }
        }, function(rets, errs) {
            if (rets) {
                if (rets.success) {
                    toastSuccess(rets.msg);
                    g_account_type = account_type;
                    getCurrentOrder(g_account_type);
                    // if(account_type=="person_user"){
                    //
                    // }else{
                    //
                    // }
                } else {
                    toastFail(rets.msg);
                }
            } else {
                toastFail("异常,请稍后重试!");
            }
        });
    }
    //账户消息
    function accountMessage() {
        alert("你点击了消息事件!");
    }
    //清屏
    function clearPanel() {
        var ids = [];
        for (var i = 0; i < g_CU.length; i++) {
            ids.push(g_CU[i].id);
        }
        map.removeAnnotations({
            ids: ids
        });
        g_CU.length = 0;
        //关闭打开的窗体
        api.closeFrame({
            name: 'nearby_company'
        });
        api.closeFrame({
            name: 'sos_button'
        });
        api.closeFrame({
            name: 'pending_order'
        });
        api.closeFrame({
            name: 'receipt_button'
        });
    }
</script>

</html>
