<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css" />
    <style type="text/css">
        html,
        body {
            height: 100%;
        }

        .wrap {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-flex-flow: column;
        }

        header {
            height: 44px;
            width: 100%;
            text-align: center;
            background-color: #81a9c3;
            color: #fff;
            line-height: 44px;
            font-size: 20px;
        }

        .flex-1 {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
        }

        footer {
            height: 30px;
            width: 100%;
            background-color: #81a9c3;
            color: white;
            line-height: 30px;
            text-align: center;
        }

        .poilist-container {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 200px;
            z-index: 10000, overflow-y: scroll;
        }

        .poilist-ul li {
            padding: 5px 0px;
            border-bottom: 1px solid #000;
        }
    </style>
</head>

<body class="wrap">
    <header>APICloud</header>
    <section class="flex-1">
        <div class="poilist-container">
            <div class="aui-content aui-margin-b-15">
                <ul id="poilist-ul" class="aui-list aui-list-in">
                    <!-- <li class="aui-list-header">带有图标、底线缩进</li> -->
                    <!-- <li class="aui-list-item">
                        <div class="aui-list-item-label-icon">
                            <i class="aui-iconfont aui-icon-home"></i>
                        </div>
                        <div class="aui-list-item-inner">
                            <div class="company-name"></div>
                            <div class="company-address"></div>
                        </div>
                    </li>
                    <li class="aui-list-item">
                        <div class="aui-list-item-label-icon">
                            <i class="aui-iconfont aui-icon-edit"></i>
                        </div>
                        <div class="aui-list-item-inner">
                            这是一个列表项
                        </div>
                    </li>
                    <li class="aui-list-item">
                        <div class="aui-list-item-label-icon">
                            <i class="aui-iconfont aui-icon-camera"></i>
                        </div>
                        <div class="aui-list-item-inner">
                            这是一个列表项
                        </div>
                    </li> -->
                </ul>
            </div>
        </div>
    </section>
    <!-- <footer>Copyright &copy;<span id="year"></span></footer> -->
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="./script/common.js"></script>
<script type="text/javascript">
    var g_my_lon, g_my_lat, g_company_lon, g_company_lat;
    var map;
    var floatModule;
    apiready = function() {
        map = api.require('bMap');
        floatModule = api.require('floatModule');
        var params = {
            rect: {
                x: 0,
                y: api.winHeight-200,
                w: api.winWidth,
                h:200
            }
        };
        floatModule.openFloat(params, function(ret) {
            alert(ret);
        });
        var header = $api.dom('header'); // 获取 header 标签元素
        var footer = $api.dom('footer'); // 获取 footer 标签元素
        // 1.修复开启沉浸式效果带来的顶部Header与手机状态栏重合的问题，最新api.js方法已支持适配iPhoneX；
        // 2.默认已开启了沉浸式效果 config.xml中 <preference name="statusBarAppearance" value="true"/>
        // 3.沉浸式效果适配支持iOS7+，Android4.4+以上版本
        var headerH = $api.fixStatusBar(header);
        // 最新api.js为了适配iPhoneX增加的方法，修复底部Footer部分与iPhoneX的底部虚拟横条键重叠的问题；
        var footerH = $api.fixTabBar(footer);
        initMapSDK();
        //setAnnotations();
    };
    //1.初始化MapSDK
    function initMapSDK() {
        if (api.systemType == "ios") {
            map.initMapSDK(function(ret) {
                if (ret.status) {
                    openbMap();
                } else {
                    alert('地图初始化失败，无法使用定位！');
                }
            });
        } else {
            openbMap();
        }
    }
    //2.初始化成功打开Map
    function openbMap() {
        map.open({
            rect: {
                x: 0,
                y: 90,
                w: api.winWidth,
                h: api.winHeight
            },
            center: {
                lon: 121.377462,
                lat: 31.47022
            },
            zoomLevel: 18,
            showUserLocation: true
        }, function(ret) {
            if (ret.status) {
                setTimeout(function() {
                    showUserLocation();
                }, 100);
                setTimeout(function() {
                    getLocationServices();
                }, 200);
            } else {
                alert('地图打开失败，无法使用定位！');
            }
        });

    }
    //3.显示用户位置
    function showUserLocation() {
        map.showUserLocation({
            isShow: true,
            trackingMode: 'none'
        });
    }
    //4.判断用户是否开启定位服务
    function getLocationServices() {
        map.getLocationServices(function(ret, err) {
            if (ret.enable) {
                getUserLocation();
            } else {
                alert("未开启定位功能！");
            }
        });
    }
    //5.获取用户位置信息
    function getUserLocation() {
        map.getLocation({
            accuracy: '10m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                g_my_lon = ret.lon;
                g_my_lat = ret.lat;
                loadNearbyCompany();
                alert(JSON.stringify(ret));
                //map.stopLocation();
            } else {
                alert('获取用户信息时出错,错误信息:' + err.code);
                map.stopLocation();
            }
        });
    }
    //7.设置商户标注信息
    function setAnnotations(annotations) {
        //此处应获取附近的商户信息  121.498034  31.385146
        map.addAnnotations({
            annotations: annotations,
            icon: 'widget://image/rescue.png',
            draggable: false
        }, function(ret) {
            if (ret) {
                if (ret.eventType == "click") {
                    return;
                }
            }
        });
    }
    //加载附近商户的信息
    function loadNearbyCompany() {
        if (g_my_lon != undefined && g_my_lat != undefined) {
            var s = 'http://' + serverIP + '/PersonUser/getNearByCompanyUser.action';
            api.ajax({
                url: s,
                method: 'post',
                data: {
                    values: {
                        lon: g_my_lon,
                        lat: g_my_lat
                    }
                }
            }, function(rets, errs) {
                if (rets) {
                    var annotations = [],
                        template = "";
                    for (var i = 0; i < rets.length; i++) {
                        var temp = {
                            "id": rets[i].id,
                            "lon": rets[i].company_location_lon,
                            "lat": rets[i].company_location_lat
                        };
                        annotations.push(temp);
                        template += (companyListTemplate(rets[i].id, rets[i].company_name, rets[i].address));
                        setBubble(rets[i].id, rets[i].company_name);
                    }
                    setAnnotations(annotations);
                    $('#poilist-ul').append(template);
                } else {
                    api.alert({
                        msg: JSON.stringify(errs)
                    });
                }
            });
        }
    }

    function GetMyLonLat() {
        var my_lon;
        var my_lat;
        map.getLocation({
            accuracy: '10m',
            autoStop: false,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                map.stopLocation();
                my_lon = ret.lon;
                my_lat = ret.lat;
            } else {
                alert(err.code);
            }
        });
    }
    //获取两点之间距离
    function getDistance(mill_lon, mill_lat, my_lon, my_lat) {
        map.getDistance({
            start: {
                lon: mill_lon,
                lat: mill_lat
            },
            end: {
                lon: my_lon,
                lat: my_lat
            }
        }, function(ret) {
            if (ret.status) {

            } else {
                alert("错误" + ret);
            }
        });
    }

    function companyListTemplate(company_no, company_name, company_address) {
        var template = '<li class="aui-list-item" data-no=' + company_no + ' onclick="popupBubble(this)">' +
            '<div class="aui-list-item-label-icon">' +
            '<i class="aui-iconfont aui-icon-home"></i>' +
            '</div>' +
            '<div class="aui-list-item-inner">' +
            '<div class="company-name">' + company_name + '</div>' +
            '<div class="company-address">' + company_address + '</div>' +
            '</div>' +
            '</li>';
        return template;
    }
    //设置商户的Bubble
    function setBubble(bubble_id, company_name) {
        map.setBubble({
            id: bubble_id,
            bgImg: 'widget://image/bubble_bg.png',
            content: {
                title: '',
                subTitle: company_name,
            },
            styles: {
                titleColor: '#000',
                titleSize: 16,
                subTitleColor: '#fff',
                subTitleSize: 12,
                illusAlign: 'left'
            }
        }, function(ret) {
            if (ret) {
                alert(JSON.stringify(ret));
            }
        });
    }
    //点击商户图标时弹出商户信息
    function popupBubble(obj) {
        var company_no = $(obj).attr('data-no');
        if (company_no != undefined) {
            map.popupBubble({
                id: company_no
            });
        }
    }
</script>
</html>
