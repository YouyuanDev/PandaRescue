<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>商户实名认证</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        .diy-p {
            text-align: center;
        }

        .diy-font-p {
            font-size: 1rem;
            color: #000;
        }

        .diy-card-bg {
            margin: auto;
            background-color: #F2F5F6;
            margin-left: 4.33333333%;
            margin-top: 4.33333333%;
        }

        .process-line {
            position: absolute;
            left: 0;
            top: 1rem;
            width: 100%;
            height: 0.2rem;
            background-color: #F2F5F6;
        }

        .process-content-tag,
        .process-content-title {
            width: 100%;
            text-align: center;
        }

        .process-content-tag span {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #F2F5F6;
        }

        .process-check,
        .process-success {
            padding-top: 3rem;
            padding-bottom: 3rem;
            text-align: center;
        }

        .process-check p:first-child {
            color: #000;
            font-size: 0.8rem;
        }

        .process-tips-container,
        .process-content-container,
        .process-cancel-container,
        .process-show-container {
            display: none;
        }

        .bg-picture {
            width: 6rem;
            height: 6rem;
            background-color: #F2F5F6;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: 100% 100%;
        }

        .bg-picture img {
            padding: 0px;
            width: 5rem;
            height: 5rem;
            margin: auto;
        }

        .bg-item {
            background-color: #F2F5F6 !important;
        }

        .bg-item-active {
            background-color: #73C0B6 !important;
        }
    </style>
</head>

<body class="pr-body-bgcolor">
    <header id="header" class="aui-bar aui-bar-nav aui-bar-light personal-header pr-bgcolor ">
        <a class="aui-pull-left aui-btn" onclick="closeMyself();">
            <span class="fa fa-chevron-left"></span>
        </a>
        <div class="aui-title  pr-fontcolor i18n1" name="merchantCA">商户认证</div>
    </header>
    <section class="aui-content-padded process-bar">
        <div class="aui-card-list">
            <div class="aui-card-list-content-padded">
                <div class="process-line">
                </div>
                <div class="aui-row process-content">
                    <div class="aui-col-xs-4 process-content-info" onclick="">
                        <div class="process-content-tag"><span>1</span></div>
                        <div class="process-content-title i18n1" name="submitdocumentinformation">提交证件信息</div>
                    </div>
                    <div class="aui-col-xs-4 process-content-info">
                        <div class="process-content-tag"><span>2</span></div>
                        <div class="process-content-title i18n1" name="audit">审核中</div>
                    </div>
                    <div class="aui-col-xs-4 process-content-info">
                        <div class="process-content-tag"><span>3</span></div>
                        <div class="process-content-title i18n1" name="attestationcompletion">认证完成</div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <section class="aui-content-padded process-content-container">
        <div class="aui-card-list">
            <div class="aui-card-list-content-padded">
                <p class="diy-font-p i18n1" name="documentinformation">证件信息</p>
                <section class="aui-grid aui-margin-b-15">
                    <div class="aui-row">
                        <div class="aui-col-xs-5 diy-card-bg bg-picture idcardfront-picture-active" onclick="uploadIdCardPictureFront();">
                            <i class="fa fa-plus"></i>
                            <div class="aui-grid-label i18n1" name="idcardfront">身份证(正面)</div>
                        </div>

                        <div class="aui-col-xs-5 diy-card-bg bg-picture idcardopposite-picture-active" onclick="uploadIdCardPictureOpposite();">
                            <i class="fa fa-plus"></i>
                            <div class="aui-grid-label i18n1" name="idcardopposite">身份证(反面)</div>
                        </div>
                        <div class="aui-col-xs-5 diy-card-bg bg-picture businesslicense-picture-active" onclick="uploadLicensePictureOpposite();">
                            <i class="fa fa-plus"></i>
                            <div class="aui-grid-label i18n1" name="businesslicense">商户营业执照</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </section>
    <section class="aui-content-padded process-show-container">
        <div class="aui-card-list">
            <div class="aui-card-list-content-padded">
                <p class="diy-font-p i18n1" name="documentinformation">证件信息</p>
                <section class="aui-grid aui-margin-b-15">
                    <div class="aui-row">
                        <div class="aui-col-xs-5 diy-card-bg bg-picture idcardfront-picture active">
                            <img src="" />
                        </div>
                        <div class="aui-col-xs-5 diy-card-bg bg-picture idcardopposite-picture active">
                            <img src="" />
                        </div>
                        <div class="aui-col-xs-5 diy-card-bg bg-picture businesslicense-picture active">
                            <img src="" />
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </section>
    <section class="aui-content-padded process-tips-container">
        <div class="aui-card-list">
            <div class="aui-card-list-content-padded process-check">
                <p class="process-tips-p"></p>
                <p class="process-tips-dsc"></p>
            </div>
        </div>
    </section>
    <div class="aui-content aui-margin-b-15 process-cancel-container">
        <div class="aui-btn aui-btn-block exit-logon pr-fontcolor pr-bgcolor i18n1" name="revocationverification" onclick="cancelAuthenticationForm();">撤销验证</div>
    </div>
    <div class="aui-content aui-margin-b-15 process-btn-container">
        <button class="aui-btn aui-btn-block exit-logon pr-fontcolor pr-bgcolor process-submit-btn i18n1" name="confirm" onclick="submitForm();">确定</button>
    </div>

</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var language_id = 0,
        g_idcard_front_picture, g_idcard_opposite_picture, g_businesslicense_picture, select_type = 0;
    apiready = function() {
            fnSettingHeader();
            //加载认证信息
            loadAuthenticationInfo();
            //图片上传事件
            registerUploadPhotosEvent();
            hlLanguage("../../i18n/");
        }
        //获取身份验证信息
    function loadAuthenticationInfo() {
        //设置认证进度为提交阶段
        $('.process-content').find('span').eq(0).addClass("bg-item-active");
        $('.process-content').find('span').eq(1).removeClass("bg-item-active");
        $('.process-content').find('span').eq(2).removeClass("bg-item-active");
        //设置默认禁用提交按钮
        $('.process-submit-btn').attr('disabled', true).removeClass('pr-bgcolor');
        //隐藏上传图片容器
        $('.process-content-container').hide();
        //隐藏显示认证信息容器
        $('.process-show-container').hide();
        //隐藏撤销认证的容器
        $('.process-cancel-container').hide();
        //设置背景图片内容为空
        $('.bg-picture').css({
            'background-image': '',
            'background-color': '#F2F5F6'
        });
        //清理图片名全局变量
        g_idcard_front_picture = undefined;
        g_idcard_opposite_picture = undefined;
        g_businesslicense_picture = undefined;
        openLoading();
        var s = 'http://' + serverIP + '/CompanyUser/getCompanyUserInfo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json'
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    //是否认证标识
                    var is_verified = ret.company.is_verified;
                    //身份证前面图片名
                    var id_card_picture_front = ret.company.id_card_picture_front;
                    //身份证背面图片名
                    var id_card_picture_back = ret.company.id_card_picture_back;
                    //营业执照图片名
                    var business_certificate_picture = ret.company.business_certificate_picture;
                    //身份证前面、背面、营业执照图片路径
                    var url = 'http://' + serverIP + '/upload/pictures/',
                        front_url, back_url, license_url;
                    if (id_card_picture_front != undefined && id_card_picture_front != "") {
                        front_url = url + id_card_picture_front;
                    }
                    if (id_card_picture_back != undefined && id_card_picture_back != "") {
                        back_url = url + id_card_picture_back;
                    }
                    if (business_certificate_picture != undefined && business_certificate_picture != "") {
                        license_url = url + business_certificate_picture;
                    }
                    //如果图片路径部位空设置相应的背景图片
                    if (front_url != undefined && back_url != undefined && license_url != undefined) {
                        $('.process-show-container .idcardfront-picture img').attr('src', front_url);
                        $('.process-show-container .idcardopposite-picture img').attr('src', back_url);
                        $('.process-show-container .businesslicense-picture img').attr('src', license_url);
                    }
                    if (is_verified != undefined && is_verified != "") {
                        if (is_verified == 0) { //未认证
                            //显示提交证件图片内容
                            $('.process-content-container').show();
                            //设置提交按钮可用
                            $('.process-submit-btn').attr('disabled', false).addClass('pr-bgcolor');
                        } else if (is_verified == 1) { //已完成
                            //设置认证进入为认证完成阶段
                            $('.process-content').find('span').addClass('bg-item-active');
                            //设置显示认证信息
                            $('.process-show-container').show();
                            //设置禁用提交按钮
                            $('.process-submit-btn').attr('disabled', true);
                        } else if (is_verified == 2) { //审核中
                            //设置认证进入为认证审核阶段
                            $('.process-content').find('span').eq(0).addClass('bg-item-active');
                            $('.process-content').find('span').eq(1).addClass('bg-item-active');
                            //显示提交的认证信息
                            $('.process-show-container').show();
                            //设置显示取消认证内容
                            $('.process-cancel-container').show();
                        } else if (is_verified == 3) { //认证失败
                            //隐藏进度
                            $('.process-bar').hide();
                            //清理提示
                            $('.process-tips-p').empty();
                            $('.process-tips-p').append('<i class="fa fa-close"></i>');
                            //设置描述内容
                            $('.process-tips-dsc').text(GetTextByLanguage("认证失败,请联系客服!", "Fail to authenticate, please contact customer service!"));
                            //提示框显示
                            $('.process-tips-container').show();
                            //提交按钮隐藏
                            $('.process-btn-container').hide();
                        }
                    } else {
                        $('.process-content-container').show();
                        $('.process-btn-container').show();
                    }
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail('系统出错,错误码:' + err.code);
            }
            closeLoading();
        });
    }
    //上传身份证正面
    function uploadIdCardPictureFront() {
        select_type = 0;
        selectPicture(1);
    }
    //上传身份证背面
    function uploadIdCardPictureOpposite() {
        select_type = 1;
        selectPicture(1);
    }
    //上传商户营业执照
    function uploadLicensePictureOpposite() {
        select_type = 2;
        selectPicture(1);
    }
    //关闭当前窗体
    function closeMyself() {
        api.closeFrame({
            name: 'company_authentication'
        });
    }
    //监听图片上传成功事件
    function registerUploadPhotosEvent() {
        //如监听网络连接事件
        api.addEventListener({
            name: 'UploadPictureEvent'
        }, function(ret, err) {
            if (ret) {
                var type = ret.value.type;
                if (!isUndefinedOrEmpty(type) && type ==1) {
                    var imgUrl = ret.value.imgUrl;
                    var url = 'http://' + serverIP + '/upload/pictures/' + imgUrl;
                    if (select_type == 0) {
                        //设置身份证正面路径为刚上传的图片
                        g_idcard_front_picture = imgUrl;
                        $('.idcardfront-picture-active').css({
                            'background-image': 'url(' + url + ')'
                        });
                    } else if (select_type == 1) {
                        //设置身份证背面路径为刚上传的图片
                        g_idcard_opposite_picture = imgUrl;
                        $('.idcardopposite-picture-active').css({
                            'background-image': 'url(' + url + ')'
                        });
                    } else if (select_type == 2) {
                        //设置营业执照图片路径为刚上传的图片
                        g_businesslicense_picture = imgUrl;
                        $('.businesslicense-picture-active').css({
                            'background-image': 'url(' + url + ')'
                        });
                    }
                }
            }
        });
    }
    //提交认证
    function submitForm() {
        if (g_idcard_front_picture == undefined || g_idcard_opposite_picture == undefined || g_businesslicense_picture == undefined) {
            toastFail("请提交所需照片!");
            return;
        }
        openLoading();
        var s = 'http://' + serverIP + '/CompanyUser/verifyCompanyUserInfo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    id_card_picture_front: g_idcard_front_picture,
                    id_card_picture_back: g_idcard_opposite_picture,
                    business_certificate_picture: g_businesslicense_picture
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                    //提交成功，从新加载认证信息
                    loadAuthenticationInfo();
                } else {
                    toastFail(ret.msg);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail('系统出错,错误码:' + err.code);
                if (ret.relogin) {
                    api.sendEvent({
                        name: 'reloginEvent'
                    });
                }
            }
            closeLoading();
        });
    }
    //撤销认证
    function cancelAuthenticationForm() {
        openLoading();
        var s = 'http://' + serverIP + '/CompanyUser/cancelVerifyCompanyUserInfo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json'
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                    //提交成功，从新加载认证信息
                    loadAuthenticationInfo();
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail('系统出错,错误码:' + err.code);
                if (ret.relogin) {
                    api.sendEvent({
                        name: 'reloginEvent'
                    });
                }
            }
            closeLoading();
        });
    }
</script>
