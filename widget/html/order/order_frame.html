<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>订单页面</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        .aui-list {
            margin-top: 1rem;
            background-color: #F2F5F6;
        }

        .aui-list .aui-list-item {
            margin-bottom: 1rem;
            background: #fff;
        }

        .fa-service {
            color: #73C0B6;
        }

        .fa-service,
        .fa-failure {
            font-size: 0.5rem;
            padding-right: 0.2rem;
        }
        .pr-empty {
            width: 100%;
            height: 100%;
            text-align: center;
            justify-content: center;
            align-items: center;
            display: -webkit-flex;
        }

        .pr-empty .empty-title {
            width: 100%;
            font-size: 1rem;
        }
    </style>
</head>

<body>
  <!-- <div class="pr-empty">
      <span class="empty-title"><span class="fa fa-info" style="padding-right:0.3rem;"></span><span class="i18n1" name="nohistoricalorder">暂无历史订单!</span><span>
</div> -->
    <div  class="aui-content aui-margin-b-15">
        <ul class="aui-list aui-media-list">
            <!-- <li class="aui-list-item aui-list-item-arrow">
                <div class="aui-media-list-item-inner">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-text">
                            <div class="aui-list-item-title"><i class="fa fa-clock-o"></i>2018年08月13日 20:21:12</div>
                            <div class="aui-list-item-right">进行中</div>
                        </div>
                        <p><span class="fa fa-circle fa-service"></span><span>门店服务<span></p>
                        <p><span class="fa fa-circle fa-failure"></span><span>轮胎故障,机械故障<span></p>
                    </div>
                </div>
            </li>
            <li class="aui-list-item aui-list-item-arrow">
                <div class="aui-media-list-item-inner">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-text">
                            <div class="aui-list-item-title"><i class="fa fa-clock-o"></i>2018年08月13日 20:21:12</div>
                            <div class="aui-list-item-right">已完成</div>
                        </div>
                        <p><span class="fa fa-circle fa-service"></span><span>门店服务<span></p>
                        <p><span class="fa fa-circle fa-failure"></span><span>轮胎故障,机械故障<span></p>
                    </div>
                </div>
            </li> -->
        </ul>
    </div>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var language_id = 0,start = 1,g_service_type_dict,g_failure_type_dict;
    apiready = function() {
        $('.pr-empty').hide();
        registerLoadAllServiceTypeEvent();
        registerLoadAllFaultTypeEvent();
        loadAllServiceType();
        loadAllFaultType();
        //下拉刷新,下拉加载
        //dropdownLoading();
        //是否滚动到底部
        isRollingToEnd();
        loadAccountOrder();
        //设置语言
        hlLanguage("../../i18n/");
    }
    //下拉刷新
    function dropdownLoading(){
      api.setRefreshHeaderInfo({
          loadingImg: 'widget://image/loading_more.gif',
          bgColor: '#ccc',
          textColor: '#fff',
          textDown: '下拉刷新...',
          textUp: '松开刷新...'
      }, function(ret, err) {
          //在这里从服务器加载数据,加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
          start=1;
          loadAccountOrder();
          setTimeout(function() {
              //执行刷新
              api.refreshHeaderLoadDone();
              hlLanguage("../i18n/");
          }, 50);
      });
    }
    //是否滚动到底部
    function isRollingToEnd(){
      api.addEventListener({
          name: 'scrolltobottom',
          extra: {
              threshold: 0 //设置距离底部多少距离时触发,默认值为0,数字类型
          }
      }, function(ret, err) {
          start = start + 1;
          loadAccountOrder();
      });
    }

    //加载订单
    function loadAccountOrder(){
      openLoading();
      var s = 'http://' + serverIP + '/Order/getAllOrderList.action';
      api.ajax({
          url: s,
          method: 'post',
          timeout: 30,
          dataType: 'json',
          data: {
              values: {
                  page: start,
                  rows: 20
              }
          }
      }, function(ret, err) {
          if (ret) {
              if (ret.success) {
                  //alert(JSON.stringify(ret));
                  if(ret.orderList.length>0){
                    var data=ret.orderList;
                    for (var i = 0; i < data.length; i++) {
                       var order_no=data[i].order_no;
                       var order_time=getDate1(data[i].order_time);
                       var order_status=data[i].order_status;
                       var service_type_code=data[i].service_type_code;
                       var failure_type_code_list=data[i].failure_type_code_list;
                        $('.aui-content .aui-list').append(getOrderTemplate(order_no,order_time,order_status,service_type_code,failure_type_code_list));
                       //getOrderTemplate();
                    }
                    changeServiceTypeFaultType();
                  }else{
                      if(start==1){
                        $('.aui-content').remove();
                        $(document.body).append();
                      }else{
                        $('.aui-content').after(addEmptyInfo());
                      }
                  }
              } else {
                  toastFail(ret.message);
                  if(ret.relogin){
                    api.sendEvent({
                        name: 'reloginEvent'
                    });
                  }
              }
          } else {
              toastFail('获取个人信息时出错,错误信息:' + err.code);
              if(ret.relogin){
                api.sendEvent({
                    name: 'reloginEvent'
                });
              }
          }
          closeLoading();
      });
    }
    //订单列表模板
    function getOrderTemplate(order_no,order_time,order_status,service_type,failure_type){
       var template='<li class="aui-list-item aui-list-item-arrow" onclick="openOrderDetail("'+order_no+'");">'+
           '<div class="aui-media-list-item-inner">'+
               '<div class="aui-list-item-inner">'+
                   '<div class="aui-list-item-text">'+
                       '<div class="aui-list-item-title"><i class="fa fa-clock-o"></i>'+order_time+'</div>'+
                       '<div class="aui-list-item-right">'+order_status+'</div>'+
                   '</div>'+
                   '<p><span class="fa fa-circle fa-service"></span><span class="span-service-type">'+service_type+'<span></p>'+
                   '<p><span class="fa fa-circle fa-failure"></span><span class="span-failure-type">'+failure_type+'<span></p>'+
               '</div>'+
           '</div>'+
       '</li>';
       return template;
    }
    //打开订单详情
    function openOrderDetail(order_no){
       alert(order_no);
    }
    function addEmptyInfo(){
      var template='<div class="pr-empty">'+
            '<span class="empty-title"><span class="fa fa-info" style="padding-right:0.3rem;"></span><span class="i18n1" name="nohistoricalorder">暂无历史订单!</span><span>'+
      '</div>';
      return template;
    }
    //注册加载所有服务类型事件
    function registerLoadAllServiceTypeEvent(){
      api.addEventListener({
          name: 'GetAllServiceTypeEvent'
      }, function(ret, err) {
        if(ret.value.g_service_type_dict!=undefined){
           g_service_type_dict=JSON.parse(ret.value.g_service_type_dict);
          //  alert(toString.call(g_service_type_dict));
          //  alert(JSON.stringify(g_service_type_dict));
        }
         //g_service_type_dict=ret.value.g_service_type_dict;
      });
    }
      //注册加载所有故障类型事件
    function registerLoadAllFaultTypeEvent(){
      api.addEventListener({
          name: 'GetAllFailureTypeEvent'
      }, function(ret, err) {
             if(ret.value.g_failure_type_dict!=undefined){

                g_failure_type_dict=JSON.parse(ret.value.g_failure_type_dict);
             }
             //g_failure_type_dict=ret.value.g_failure_type_dict;
      });
    }
    //更换服务和故障类型
    function changeServiceTypeFaultType(){
      if(g_service_type_dict!=undefined&&g_failure_type_dict!=undefined){
         $('.span-service-type').each(function(){
            var text=$(this).text();
            for (var key in g_service_type_dict) {
                if(text==key){
                    $(this).text(g_service_type_dict[key].service_type_name);
                }
            }
         });
         $('.span-failure-type').each(function(){
            var text=$(this).text();
            var arr=text.split(',');
            var str="";
            for (var i = 0; i < arr.length; i++) {
              for (var key in g_failure_type_dict) {
                  if(arr[i]==key){
                      str+=g_failure_type_dict[key].failure_type_name+",";

                  }
              }
            }
            $(this).text(str.substring(0,str.length-1));
         });
      }
    }
</script>
