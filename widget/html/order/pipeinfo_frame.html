<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>涂层生产信息</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        html,
        body {
            height: 100%;
            background-color: #f4f5f6;
        }

        .process-button {
            background-color: #19AD68;
            width: 200px;
            height: 43px;
            text-align: center;
            line-height: 43px;
            color: #ffffff;
            margin-right: 2px;
        }

        .foot-container .process-button:last-child {
            margin-right: 0px;
        }

        .loadmore-btn {
            background-color: #f2f2f2;
            color: #4682B4;
            height: 43px;
            text-align: center;
            line-height: 43px;
            width: 95%;
            margin: 0 auto;
            outline: none;
        }

        .pipeinfo-table tr td:nth-child(even) {
            text-align: center;
        }
        /*.dataintable,.dataintable tr {
           width:100%;
         }
         .dataintable tr td{
             width:100px;
             margin-top:5px;
             font-size:14px;
         }
        .dataintable  tr td:nth-child(odd){
            text-align: left;
            color: #7A7A7A;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            background-color:red;
        }
        .dataintable  tr td:nth-child(even){
            text-align: center;;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }*/
    </style>
</head>

<body>
    <div id="main" style="overflow-y:scroll;-webkit-overflow-scrolling:touch;width:95%;margin:0 auto;">
        <div style="width:100%;height:auto;overflow-x: hidden;">
            <table class="pipeinfo-table">
                <thead>
                    <tr>
                        <th class="i18n1" name="pipebasicinfo" colspan="4" style="text-align:center;">钢管基础信息</th>
                    </tr>
                </thead>
                <tr>
                    <td class="i18n1" name="pipeno"></td>
                    <td class="pipe_no"></td>
                    <td class="i18n1" name="statusname"></td>
                    <td class="status_name"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="od"></td>
                    <td class="od"></td>
                    <td class="i18n1" name="wt"></td>
                    <td class="wt"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="length"></td>
                    <td class="p_length"></td>
                    <td class="i18n1" name="weight"></td>
                    <td class="weight"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="grade"></td>
                    <td class="grade"></td>
                    <td class="i18n1" name="heatno"></td>
                    <td class="heat_no"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="externalcoating"></td>
                    <td class="external_coating"></td>
                    <td class="i18n1" name="internalcoating"></td>
                    <td class="internal_coating"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="projectno"></td>
                    <td class="project_no"></td>
                    <td class="i18n1" name="projectname"></td>
                    <td class="project_name"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="contractno"></td>
                    <td class="contract_no"></td>
                    <td class="i18n1" name="pipemakinglotno"></td>
                    <td class="pipe_making_lot_no"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="centerlinecolor"></td>
                    <td class="center_line_color"></td>
                    <td class="i18n1" name="pipeendcolor"></td>
                    <td class="pipe_end_color"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="rebevelmark"></td>
                    <td class="rebevel_mark"></td>
                    <td class="i18n1" name="clientspec"></td>
                    <td class="client_spec"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="odsamplingmark"></td>
                    <td class="odsampling_mark"></td>
                    <td class="i18n1" name="idsamplingmark"></td>
                    <td class="idsampling_mark"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="oddscsamplemark"></td>
                    <td class="od_dsc_sample_mark"></td>
                    <td class="i18n1" name="odpesamplemark"></td>
                    <td class="od_pe_sample_mark"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="idglasssamplemark"></td>
                    <td class="id_glass_sample_mark"></td>
                    <td class="i18n1" name="shipmentdate"></td>
                    <td class="shipment_date"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="odcoatingdate"></td>
                    <td class="od_coating_date"></td>
                    <td class="i18n1" name="idcoatingdate"></td>
                    <td class="id_coating_date"></td>
                </tr>

            </table>
        </div>
        <div id="qrdiv" style="width:100%;height:auto;margin-top:20px;" onclick="printQRCode()">
            <div style="margin:0px auto;text-align:center;" id="qrcodeCanvas"></div>
            <div style="margin:0px auto;text-align:center;font-size: 14px" id="qrcodeText"></div>
        </div>

        <div class="loadmore-div" style="height:auto;margin-top:20px;font-size: 16px;color:#000000;font-family:" Sans-serif ";">
            <div class="loadmore-btn i18n1" name="loadmorninfo" onclick="loadMoreInfo()">更多生产信息...</div>
        </div>
        <div id="pipe-process-info" style="width:100%;height:auto;margin:0 auto;overflow-x: hidden;">

        </div>
    </div>

</body>

</html>

<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<!-- <script type="text/javascript" src="../../script/jquery-1.11.1.js" ></script> -->
<script type="text/javascript" src="../../script/jquery.qrcode.js"></script>
<script type="text/javascript" src="../../script/qrcode.js"></script>
<script type="text/javascript" src="../../script/utf.js"></script>
<script type="text/javascript">
    var pipeno;
    var showmore = false;
    var g_result_input_output;
    //var imageBrowser;
    apiready = function() {
            LoadProcess_input_output();
            var data = api.pageParam;
            pipeno = data.pipeno;

            //下拉刷新，钢管信息
            dropdownLoading();
            //urloptions =data.urloptions;
            if (pipeno != undefined) {
                SearchpipeInfo();
            } else {
                alert("查询出现异常!");
                return;
            }


        }
        // $(function(){
        //   $(document).on('click','.upload-pictures',function(){
        //       alert(4);
        //       setBrowsePicutre(this);
        //   });
        // });
        //查看图片事件
    function setBrowsePicutre(obj) {
        var picturelistStr = $(obj).attr('data-list');
        if (picturelistStr != undefined && picturelistStr.length > 0) {
            var picturelist = picturelistStr.split(";");
            if (picturelist.length > 0) {
                var picturelistArr = [];
                var url = "http://" + serverIP + "/upload/pictures/";
                for (var i = 0; i < picturelist.length; i++) {
                    if (picturelist[i] != undefined && picturelist[i].trim().length > 0)
                        picturelistArr.push(url + picturelist[i]);
                }
                var imageBrowser = api.require('imageBrowser');
                imageBrowser.openImages({
                    showList: true,
                    imageUrls: picturelistArr
                });
            } else {
                alert("暂无图片!");
            }
        } else {
            alert("暂无图片!");
        }
    }

    // 查询钢管详细信息
    function SearchpipeInfo() {
        //alert(pipeno);
        var s = 'http://' + serverIP + '/APPRequestTransfer/getCoatingInfoByPipeNo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    pipe_no: pipeno
                }
            }
        }, function(ret, err) { //alert(ret);
            api.hideProgress();
            if (ret) {
                if (ret.success == false) {
                    api.alert({
                        msg: JSON.stringify(ret.message)
                    });
                } else {
                    pipeinfo = ret.pipeinfo;
                    urloptions = ret.urloptions;
                    //显示钢管基础信息
                    showPipeBasicInfo(pipeinfo);
                    //显示下一工序选项，通知pipeinforoot.html刷新 选项按钮
                    // api.sendEvent({
                    //     name: 'showNextProcessOptions',
                    //     extra: {
                    //         urloptions: urloptions
                    //     }
                    // });
                    //alert("showNextProcessOptions="+JSON.stringify(ret.urloptions));
                    var jsfun = 'showNextProcessOptions(' + JSON.stringify(ret.urloptions) + ');';
                    api.execScript({
                        name: 'pipeinforoot',
                        script: jsfun
                    });
                    //若已经显示了所有工序信息，则刷新
                    if (showmore) {
                        loadMoreInfo();
                    }
                    hlLanguage("../../i18n/");
                }
            } else {
                //alert("err");
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        });
    }

    //下拉刷新更新钢管基础信息
    function dropdownLoading() {
        api.setRefreshHeaderInfo({
            loadingImg: 'widget://image/loading_more.png',
            bgColor: '#ccc',
            textColor: '#fff',
            textDown: '下拉刷新...',
            textUp: '松开刷新...'
        }, function(ret, err) {
            // alert(2);
            //在这里从服务器加载数据,加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
            //重新刷新
            //alert("kaishi shuaxin");
            $('#qrcodeCanvas').empty();
            SearchpipeInfo();
            setTimeout(function() {
                //执行刷新
                api.refreshHeaderLoadDone();
            }, 50);
        });
    }

    //显示钢管基础信息
    function showPipeBasicInfo(pipeinfo) {
        $('.contract_no').text(pipeinfo.contract_no);
        $('.status_name').text(pipeinfo.status_name);
        $('.weight').text(pipeinfo.weight);
        $('.client_spec').text(pipeinfo.client_spec);
        $('.project_name').text(pipeinfo.project_name);
        $('.pipe_no').text(pipeinfo.pipe_no);
        $('.project_no').text(pipeinfo.project_no);
        $('.p_length').text(pipeinfo.p_length);
        $('.external_coating').text(pipeinfo.external_coating);
        $('.od').text(pipeinfo.od);
        $('.grade').text(pipeinfo.grade);
        $('.wt').text(pipeinfo.wt);
        $('.pipe_making_lot_no').text(pipeinfo.pipe_making_lot_no);
        $('.heat_no').text(pipeinfo.heat_no);
        $('.internal_coating').text(pipeinfo.internal_coating);
        $('.center_line_color').text(pipeinfo.center_line_color);
        $('.pipe_end_color').text(pipeinfo.pipe_end_color);
        $('.rebevel_mark').text(pipeinfo.rebevel_mark);
        $('.odsampling_mark').text(pipeinfo.odsampling_mark);
        $('.idsampling_mark').text(pipeinfo.idsampling_mark);
        $('.od_dsc_sample_mark').text(pipeinfo.od_dsc_sample_mark);
        $('.od_pe_sample_mark').text(pipeinfo.od_pe_sample_mark);
        $('.id_glass_sample_mark').text(pipeinfo.id_glass_sample_mark);
        $('.shipment_date').text(formatterdate(pipeinfo.shipment_date));
        $('.od_coating_date').text(formatterdate(pipeinfo.od_coating_date));
        $('.id_coating_date').text(formatterdate(pipeinfo.id_coating_date));

        //QRCode
        GenerateQRCode(pipeinfo.pipe_no);

    }
    //更多生产信息
    function loadMoreInfo() {
        showmore = true;
        //清空moreinfo
        $('#pipe-process-info').empty();
        var s = 'http://' + serverIP + '/pipeinfo/searchPipeRecord.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    pipe_no: pipeno
                }
            }
        }, function(ret, err) { //alert(ret);
            //api.hideProgress();
            if (ret) {
                var data = ret;
                var flag = false;
                var language = getCookie("userLanguage");
                if (data.length > 0)
                    flag = true;
                for (var i = 0; i < data.length; i++) {
                    for (var key in data[i]) {
                        if (key.indexOf('header') == -1) {
                            getTemplate(key, data[i][key], language, data[i][key + "_header"]);
                        }
                    }
                }
                if (!flag) {
                    api.alert({
                        title: '提示',
                        msg: '暂无更多内容',
                    }, function(ret, err) {

                    });
                } else {
                    $('.loadmore-div').remove();
                }
                hlLanguage("../../i18n/");
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        });

    }

    // function recordTemplate(recordEnName, recordName, dict) {
    //     var template = "";
    //     var i = 1;
    //     template += '<table  style="width:100%;" class="dataintable"><thead><tr><th class="i18n1" name="' + recordEnName + '" colspan="6">' + recordName + '</th></tr></thead>';
    //
    //     for (var key in dict) {
    //         template += '<tr style="width:100%;">';
    //         template += ' <td style="width:50%;color: #7A7A7A;padding:5px 0px;word-break: break-all;word-wrap: break-word;" class="i18n1 pipeinfo-td" name="' + key + '">' + key + '</td>';
    //         if (dict[key] == undefined || dict[key] == -99)
    //             dict[key] = "";
    //         if (key == "uploadfiles") {
    //             template += '<td style="width:50%;text-align:center;padding:5px 0px;" class="pipeinfo-td" ><div style="color:#87CEEB;" onclick="setBrowsePicutre(this);" data-list="' + dict[key] +
    //                 '" class="upload-pictures i18n1" name="viewpicture">图片</div></td>';
    //         } else if (key == "stencilcontent") {
    //             if (dict[key] != undefined) {
    //                 dict[key] = dict[key].replace(/(\r\n)|(\n)/g, '<br>');
    //             }
    //             template += '</td></tr><tr style="width:100%;"><td colspan="2" style="text-align:left;padding:5px 0px;color:#000000;" class="pipeinfo-td">' + dict[key] + '</td>';
    //         } else {
    //             template += ' <td style="width:50%;text-align:center;padding:5px 0px;" class="pipeinfo-td">' + dict[key] + '</td>';
    //         }
    //         template += '</tr>';
    //     }
    //     template += '</table><br>';
    //     //alert(template);
    //     return template;
    // }

    function getTemplate(process_code, array, language, header_dict) {

        var template = "";
        template += '<table  title="" class="dataintable"><thead><tr><th class="i18n1" name="' + process_code + '" colspan="6">' + process_code + '</th></tr></thead><tbody>';
        var remark = "",
            result = "",
            result_name = "",
            uploadfiles = "";

        for (var i = 0; i < array.length; i++) {
            template += '<tr>';
            var dict = header_dict;
            remark = dict.remark;
            result = dict.result;
            uploadfiles = dict.upload_files;
            for (var t = 0; t < g_result_input_output.length; t++) {
                if (g_result_input_output[t].process_code == process_code) {
                    for (var w = 0; w < g_result_input_output[t].output.length; w++) {
                        if (g_result_input_output[t].output[w].result == result) {
                            if (language == "en") {
                                result_name = g_result_input_output[t].output[w].result_name_en;
                            } else {
                                result_name = g_result_input_output[t].output[w].result_name;
                            }
                        }
                    }
                }
            }

            var max_value = array[i].max_value;
            var min_value = array[i].min_value;
            var item_value = array[i].item_value == undefined ? "" : array[i].item_value;
            var range = "";
            var flag = false;
            if (max_value != undefined && min_value != undefined) {
                if (array[i].need_verify != undefined && array[i].need_verify == "1") {
                    range = "(" + min_value + "~" + max_value + ")";
                    if (item_value != undefined && !isNaN(item_value)) {
                        if (parseFloat(max_value) < parseFloat(item_value))
                            flag = true;
                        if (parseFloat(min_value) > parseFloat(item_value))
                            flag = true;
                    }
                }
            }
            if (language && language == "en") {
                var unit = (array[i].unit_name_en == undefined || array[i].unit_name_en == "") ? "" : ' (' + array[i].unit_name_en + ') ';
                template += ' <td>' + array[i].item_name_en + unit + range + '</td>';
            } else {
                var unit = (array[i].unit_name == undefined || array[i].unit_name_en == "") ? "" : ' (' + array[i].unit_name + ') ';
                template += ' <td>' + array[i].item_name + unit + range + '</td>';
            }
            if (flag) {
                template += '<td>' + item_value + '</td>';
            } else {
                template += '<td>' + item_value + '</td>';
            }
            template += '</tr>';
        }
        template += '<tr>';
        template += ' <td class="i18n1" name="result">结果</td>';
        template += ' <td>' + result_name + '</td>';
        template += '</tr>';
        //图片
        template += '<tr>';
        template += '<td class="i18n1" name="viewpicture">查看图片</td>';
        if(uploadfiles!=undefined&&uploadfiles!=""){
          template += '<td style="width:50%;text-align:center;padding:5px 0px;" class="pipeinfo-td" ><div style="color:#87CEEB;" onclick="setBrowsePicutre(this);" data-list="' + uploadfiles +
              '" class="upload-pictures i18n1" name="viewpicture">图片</div></td>';
        }else{
          template += '<td style="width:50%;text-align:center;padding:5px 0px;" class="pipeinfo-td" ><div style="color:#87CEEB;" class="upload-pictures i18n1" name="nopictures">无图片</div></td>';

        }

        template += '</tr>';
        template += '<tr>';
        template += ' <td class="i18n1" name="remark">备注</td>';
        template += ' <td>' + remark + '</td>';
        template += '</tr></tbody></table>';
        $('#pipe-process-info').append(template);
    }




    function GenerateQRCode(pipeno) {
        jQuery('#qrcodeCanvas').qrcode({
            render: "canvas",
            text: pipeno,
            width: "100", //二维码的宽度
            height: "100", //二维码的高度
            background: "#ffffff", //二维码的后景色
            foreground: "#000000", //二维码的前景色
            src: '../../image/logo2.jpg' //二维码中间的图片
        });

        $('#qrcodeText').text('P/N:' + pipeno);
    }

    function printQRCode() {
        api.confirm({
            title: '提示',
            msg: '是否打印二维码?',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret.buttonIndex == 1) {


            }
        });
    }

    function LoadProcess_input_output() {
        var s = 'http://' + serverIP + '/data/process_input_output.json';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json'
        }, function(ret, err) {
            if (ret) {
                g_result_input_output = ret;
            }
        });
    }
</script>
