<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>消息Frame</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        .item-historical-container {
            width: 100%;
            text-align: center;
            height: 40px;
            line-height: 40px;
        }

        .aui-list .aui-list-item-media {
            width: 3rem;
            padding-right: 0.5rem;
        }

        .aui-list .aui-list-item-text {
            width: 100%;
        }

        .aui-list .aui-list-item-title .item-name {
            width: 7.5rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .aui-list .aui-list-item-text .item-title {
            width: 13rem;
            padding-top: 0.2rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .pr-empty {
            padding: 5px 10px;
            text-align: center;
            display: none;
        }

        .connection-failed-tip {
            display: none;
        }
    </style>
</head>

<body>
    <div class="aui-tips connection-failed-tip" id="tips-1">
        <i class="aui-iconfont aui-icon-info"></i>
        <div class="aui-tips-title">连接服务器失败!</div>
        <i class="aui-iconfont aui-icon-close" onclick="closeAuiTip();"></i>
    </div>
    <p>
        <div class="aui-btn aui-btn-block aui-btn-outlined" onclick="openChat(1,'醉卧沙场笑看红尘','../../image/default_portrait.png')">18703611326</div>
    </p>
    <p>
        <div class="aui-btn aui-btn-block aui-btn-outlined" onclick="openChat(15,'Dr.K','../../image/default_portrait.png')">13774216002</div>
    </p>
    <div class="aui-content aui-margin-b-15 pr-body-bgcolor">
        <ul class="aui-list aui-media-list item-list" id="hh_list">

        </ul>
    </div>
    <div class="pr-empty">
        <span class="empty-title"><span class="fa fa-info" style="padding-right:0.3rem;"></span><span class="i18n1" name="nohistoricalmessage">暂无消息!</span><span>
    </div>
    <div class="item-historical-container" onclick="openHistoricalMessage();">
        <span><span class="aui-margin-l-5 pr-fontcolor1">历史消息</span><span class="fa fa-chevron-right pr-fontcolor1"></span></span>
    </div>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var language_id = 0;
    var rong;
    var g_senderUserId = new Array();
    apiready = function() {
            rong = api.require('rongCloud2');
            getConversationList();
            api.setRefreshHeaderInfo({
                loadingImg: 'widget://image/loading.png',
                bgColor: '#ccc',
                textColor: '#fff',
                textDown: '下拉刷新...',
                textUp: '松开刷新...'
            }, function(ret, err) {
                getConversationList();
                setTimeout(function() {
                    api.refreshHeaderLoadDone();
                }, 6000)
            });
            api.addEventListener({
                name: 'UpdateConversationListEvent'
            }, function(ret, err) {
                getConversationList();
            });
            // rong.init(function(ret, err) {
            //     if (ret.status == 'success') {
            //         //消息监听
            //         //registerReceiveMessageListener();
            //         //语音监听
            //         registerUpdateConversationListListener();
            //         rong.connect({
            //             token: $api.getStorage('token')
            //         }, function(ret, err) {
            //             if(ret.status=='success'){
            //               //如果有未读的消息，则发送事件
            //               rong.getTotalUnreadCount(function(ret, err) {
            //                  if(ret.status=='status'){
            //                    api.sendEvent({
            //                        name: 'updateTotalReceiveMessageEvent',
            //                        extra: {
            //                            total: ret.result
            //                        }
            //                    })
            //                  }
            //               })
            //             }
            //         });
            //     } else {
            //         toastFail("系统异常,聊天初始化失败!");
            //     }
            // });
            // getConversationList();


            hlLanguage("../../i18n/");
        }
        //获取最近回话列表
    function getConversationList() {
        rong.getConversationList(function(ret, err) {
            if (ret.status == 'success') {
                var html = '';
                for (var i in ret.result) {
                    var rs = ret.result[i];
                    var senderUserId = rs.senderUserId;
                    var targetId = rs.targetId;
                    if (senderUserId == $api.getStorage('id')) {
                        break;
                    }
                    if ($.inArray(senderUserId, g_senderUserId) != -1) {
                        $("li[data-sender-id='" + senderUserId + "']").remove();
                    } else {
                        g_senderUserId.push(senderUserId);
                    }
                    var extra = transExtra(rs.latestMessage.extra);
                    if (extra.xm1 == $api.getStorage('zh')) {
                        var xm = extra.xm2;
                        var tx = extra.tx2;
                    } else {
                        var xm = extra.xm1;
                        var tx = extra.tx1;
                    }
                    if (rs.unreadMessageCount > 0 && extra.xm2 == $api.getStorage('zh')) {
                        var shu = '<div class="aui-badge">' + rs.unreadMessageCount + '</div>';
                    } else {
                        var shu = '';
                    }
                    if (rs.objectName == 'RC:TxtMsg') {
                        xx = expressionConversion(rs.latestMessage.text);
                        var types = '<div class="aui-list-item-text aui-font-size-12">' + xx + '</div>'
                    } else if (rs.objectName == 'RC:ImgMsg') {
                        var types = '<div class="aui-list-item-text aui-font-size-12 aui-text-success">[图像消息]</div>'
                    } else if (rs.objectName == 'RC:VcMsg') {
                        var types = '<div class="aui-list-item-text aui-font-size-12 aui-text-primary">[语音消息]</div>'
                    }
                    html += '<li class="aui-list-item aui-list-item-middle" data-sender-id="' + senderUserId + '" onclick="openChat(' + "'" + senderUserId + "'" + ',' + "'" + xm + "'" + ',' + "'" + tx + "'" + ')">';
                    html += '     <div class="aui-media-list-item-inner">';
                    html += '               <div class="aui-list-item-media wechat-avatar">';
                    html += shu;
                    html += '                        <img src="' + tx + '" onerror="imgExists(this);"/></div>';
                    html += '                        <div class="aui-list-item-inner">';
                    html += '                <div class="aui-list-item-text">';
                    html += '                     <div class="aui-list-item-title">' + xm + '</div><div class="aui-list-item-right">' + timeDifference(rs.sentTime) + '</div></div>';
                    html += types;
                    html += '           </div>';
                    html += '     </div>';
                    html += '</li>';
                    $api.html($api.dom('#hh_list'), html);
                    html = "";
                }
                api.refreshHeaderLoadDone();
            }
        })
    }

    //打开聊天界面
    function openChat(id, xm, tx) {
        api.openWin({
            reload: true,
            name: 'chat',
            url: './chat.html',
            pageParam: {
                id: id,
                zh: xm,
                tx: tx
            },
            vScrollBarEnabled: false,
        });
        if ($api.getStorage('id') == id) {

        } else {
            rong.clearMessagesUnreadStatus({
                conversationType: 'PRIVATE',
                targetId: id
            }, function(ret, err) {})
        }
        api.sendEvent({
            name: 'UpdateConversationListEvent'
        });
    }
    //打开历史消息页面
    function openHistoricalMessage() {
        api.openWin({
            name: 'historical_message',
            url: './historical_message.html',
            reload: true,
            pageParam: {}
        });
    }
    //融云消息监听器
    function registerReceiveMessageListener() {
        rong.setOnReceiveMessageListener(function(ret, err) {
            if (ret) {
                //发送更新会话列表命令
                api.sendEvent({
                    name: 'UpdateConversationListEvent'
                });
                // 发送最新消息命令
                api.sendEvent({
                    name: 'new_msg',
                    extra: {
                        msg: ret.result.message
                    }
                })
            }
        })
    }
    //更新回话列表监听器
    function registerUpdateConversationListListener() {
        //发送更新会话列表命令
        api.addEventListener({
            name: 'UpdateConversationListEvent'
        }, function(ret, err) {
            getConversationList();
        });
    }
</script>
