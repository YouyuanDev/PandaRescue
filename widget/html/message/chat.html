<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>聊天页面</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        .item-voice {
            width: 1.5rem;
            height: 1.5rem;
            background: url('../../image/voice_48.png');
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
        }

        .item-file {
            width: 1.5rem;
            height: 1.5rem;
            background: url('../../image/add_48.png');
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
        }

        .item-text-container {
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .item-text-container .item-text {
            width: 100%;
            height: 30px;
            border-bottom: 1px solid #73C0B6;
        }

        #footer {
            /*height:180px;*/
        }

        .item-text {}
    </style>
</head>

<body class="pr-body-bgcolor">
    <header id="header" class="aui-bar aui-bar-nav aui-bar-light personal-header pr-bgcolor">
        <a class="aui-pull-left aui-btn" onclick="closeMyself();">
            <span class="fa fa-chevron-left"></span>
        </a>
        <div class="aui-title pr-fontcolor item-title-name"></div>
    </header>
    <!-- <footer class="aui-bar aui-bar-nav aui-bar-tab" id="footer">
        <a class="aui-pull-left aui-btn">
            <span class="item-voice"></span>
        </a>
        <div class="aui-title">
            <div class="item-text-container">
                <textarea rows="5" cols="20" class="item-text" onpropertychange="registerTextareaChange(this);" oninput="registerTextareaChange(this);"></textarea>
            </div>
        </div>
        <a class="aui-pull-right aui-btn">
            <span class="item-file"></span>
        </a>
    </footer> -->
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var language_id = 0;
    var rong;
    var UIChatTools;
    var fs;
    apiready = function() {
        rong = api.require('rongCloud2');
        UIChatTools = api.require('UIChatTools');
        fs = api.require('fs');
        openUIChatTools();
        registerRecorderListener();
        var data = api.pageParam;
        var name = data.name;
        if (name != undefined) {
            $('.item-title-name').text(name);
        }
        fnSettingHeader();
        var header = $api.byId('header');
        var headerH = $api.offset(header).h;
        // var footer = $api.byId('footer');
        // var footerH = $api.offset(footer).h;
        // api.openFrame({
        //     name: 'chat_footer_frame',
        //     url: './chat_footer_frame.html',
        //     rect: {
        //         x: 0,
        //         y: api.winHeight -50,
        //         w: 'auto',
        //         h:'auto'
        //     },
        //     bounces:true
        // });
        //初始化融云聊天模块
        initRongClound();
        hlLanguage("../../i18n/");
    }

    //---------------以下为融云聊天接口接入
    //----1.0 初始化init
    function initRongClound() {
        rong.init(function(ret, err) {
            if (ret.status == 'success') {
                toastSuccess("初始化成功!");
                connectRongClound();
            } else {
                toastFail("系统异常,初始化聊天失败!错误码:" + err.code);
            }
        });
    }
    //----2.0 连接聊天服务器
    function connectRongClound() {
        var token = getToken();
        if (token != undefined) {
            rong.connect({
                token: token
            }, function(ret, err) {
                if (ret.status == 'success') {
                    toastSuccess("连接成功,当前用户id=" + ret.result.userId);
                } else {
                    toastFail("系统异常,连接聊天服务器失败!错误码:" + err.code);
                }
            });
        }
    }
    //打开聊天对话框
    function openUIChatTools() {
        UIChatTools.open({
            chatBox: {
                placeholder: '聊天内容',
                autoFocuse: false,
                maxRows: 6
            },
            styles: {
                bgColor: '#D1D1D1',
                margin: 10
            },
            isShowAddImg: false,
            tools: {
                h: 44,
                iconSize: 30,
                recorder: {
                    normal: 'widget://image/recorder_normal_48.png',
                    selected: 'widget://image/recorder_selected_48.png'
                },
                image: {
                    normal: 'widget://image/image_normal_48.png',
                    selected: 'widget://image/image_selected_48.png'
                },
                face: {
                    normal: 'widget://image/face_normal_48.png',
                    selected: 'widget://image/face_selected_48.png'
                },
                append: {
                    normal: 'widget://image/append_normal_48.png',
                    selected: 'widget://image/append_selected_48.png'
                }
            },
            emotions: ['widget://emotions/basic']
        }, function(ret) {
            if (ret) {
                //发送消息
                if (ret.eventType == "send") {
                    //获取输入框内容
                    UIChatTools.value(function(ret, err) {
                        if (ret) {
                            alert(JSON.stringify(ret));
                        } else {
                            alert(JSON.stringify(err));
                        }
                    });
                    toastSuccess("发送了消息");
                }
            }
        });
    }
    //注册监听录音按钮
    function registerRecorderListener() {
        var recorderPath, duration;
        UIChatTools.recorderListener(function(ret) {
            if (ret.eventType == 'press' && ret.target == 'talkback') {
                console.log("录音按钮摁下!");
                createFile(recorderPath);
                api.startRecord({
                });
                UIChatTools.startTimer();
            }
            if (ret.eventType == 'auditionTouchOn' && ret.target == 'talkback') {
                console.log("试听录音!"); //此处结束录音
                api.stopRecord(function(ret, err) {
                    if (ret) {
                        recorderPath = ret.path;
                        duration = ret.duration;
                        console.log("试听录音，路径="+ret.path);
                        //console.log("recorderName="+recorderName);
                        console.log("试听录音，时长="+ret.duration);
                    }
                });
            }
            if (ret.eventType == "shortTime" && ret.target == 'talkback') {
                toastFail('录音时间太短!');
                console.log("录音时间太短!"); //此处删除录音
                //removeFile(recorderPath);
            }
            if (ret.eventType == 'audition') {
                console.log("开始试听录音!"); //此处播放录音
                //var path="widget://recorder/"+recorderName;
                console.log("开始试听录音!路径="+recorderPath); //此处播放录音
                api.startPlay({
                    path: recorderPath
                }, function(ret, err) {
                    if (ret) {
                        console.log('播放完成');
                    } else {
                        console.log(JSON.stringify(err));
                    }
                });
            }
            if (ret.eventType == "cancel") {
                console.log("取消录音!"); //此处删除录音
                //removeFile(recorderPath);
            }
            if (ret.eventType == 'send' && ret.target == 'record') {
                console.log('发送录音');
            }
        });
    }

    //关闭当前窗口
    function closeMyself() {
        api.closeWin({
            name: 'chat'
        });
    }
    //fs创建文件
    function createFile(path) {
        fs.createFile({
            path: path
        }, function(ret, err) {
            if (ret.status) {
                console.log("创建文件成功!");
            } else {
                console.log("创建文件失败!");
            }
        });
    }
    //fs删除文件
    function removeFile(path) {
        fs.remove({
            path:path
        }, function(ret, err) {
            if (ret.status) {
                console.log(JSON.stringify(ret));
            } else {
                console.log(JSON.stringify(err));
            }
        });
    }
</script>
