<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>历史消息Frame</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        .item-historical-container {
            width: 100%;
            text-align: center;
            height: 40px;
            line-height: 40px;
        }

        .aui-list .aui-list-item-media {
            width: 3rem;
            padding-right: 0.5rem;
        }

        .aui-list .aui-list-item-text {
            width: 100%;
        }

        .aui-list .aui-list-item-title .item-name {
            width: 7.5rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .aui-list .aui-list-item-text .item-title {
            width: 13rem;
            padding-top: 0.2rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .pr-empty {
            padding: 5px 10px;
            text-align: center;
            display: none;
        }
    </style>
</head>

<body>
    <div class="aui-content aui-margin-b-15 pr-body-bgcolor">
        <ul class="aui-list aui-media-list item-list" id="hh_list">

        </ul>
    </div>
    <div class="pr-empty">
        <span class="empty-title"><span class="fa fa-info" style="padding-right:0.3rem;"></span><span class="i18n1" name="loaded">加载完毕!</span><span>
    </div>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var language_id = 0;
    var rong;
    var g_startTime=0;
    var g_senderUserId = new Array();
    apiready = function() {
            rong = api.require('rongCloud2');
            getConversationListByCount(g_startTime);
            hlLanguage("../../i18n/");
        }
        //分页获取回话列表
    function getConversationListByCount(startTime) {
        rong.getConversationListByCount({
          typeList:['private','group','discussion','system'],
          count:10,
          startTime:g_startTime
        },function(ret, err) {
            if (ret.status == 'success') {
                var html = '';
                if(ret.result.length<=0){
                  $('.pr-empty').show();
                }
                for (var i in ret.result) {
                    var rs = ret.result[i];
                    var senderUserId = rs.senderUserId;
                    var targetId = rs.targetId;
                    // if (senderUserId == $api.getStorage('id')) {
                    //     break;
                    // }
                    if ($.inArray(senderUserId, g_senderUserId) != -1) {
                        $("li[data-sender-id='" + senderUserId + "']").remove();
                    } else {
                        g_senderUserId.push(senderUserId);
                    }
                    var extra = transExtra(rs.latestMessage.extra);
                    if (extra.xm1 == $api.getStorage('zh')) {
                        var xm = extra.xm2;
                        var tx = extra.tx2;
                    } else {
                        var xm = extra.xm1;
                        var tx = extra.tx1;
                    }
                    if (rs.unreadMessageCount > 0 && extra.xm2 == $api.getStorage('zh')) {
                        var shu = '<div class="aui-badge">' + rs.unreadMessageCount + '</div>';
                    } else {
                        var shu = '';
                    }
                    if (rs.objectName == 'RC:TxtMsg') {
                        xx = expressionConversion(rs.latestMessage.text);
                        var types = '<div class="aui-list-item-text aui-font-size-12">' + xx + '</div>'
                    } else if (rs.objectName == 'RC:ImgMsg') {
                        var types = '<div class="aui-list-item-text aui-font-size-12 aui-text-success">[图像消息]</div>'
                    } else if (rs.objectName == 'RC:VcMsg') {
                        var types = '<div class="aui-list-item-text aui-font-size-12 aui-text-primary">[语音消息]</div>'
                    }
                    html += '<li class="aui-list-item aui-list-item-middle" data-sender-id="' + senderUserId + '" onclick="openHistoricalMessageFrame(' + "'" + senderUserId + "'" + ',' + "'" + xm + "'" + ',' + "'" + tx + "'" + ')">';
                    html += '     <div class="aui-media-list-item-inner">';
                    html += '               <div class="aui-list-item-media wechat-avatar">';
                    html += shu;
                    html += '                        <img src="' + tx + '" onerror="imgExists(this);"/></div>';
                    html += '                        <div class="aui-list-item-inner">';
                    html += '                <div class="aui-list-item-text">';
                    html += '                     <div class="aui-list-item-title">' + xm + '</div><div class="aui-list-item-right">' + timeDifference(rs.sentTime) + '</div></div>';
                    html += types;
                    html += '           </div>';
                    html += '     </div>';
                    html += '</li>';
                    $api.html($api.dom('#hh_list'), html);
                    html = "";
                }
                api.refreshHeaderLoadDone();
            }else{
               $('.pr-empty').show();
            }
        })
    }
    function openHistoricalMessageFrame(id,zh,tx){
      api.openWin({
          reload: true,
          name: 'historical_message',
          url: './historical_message.html',
          pageParam: {
              id: id,
              zh: zh,
              tx: tx
          },
          vScrollBarEnabled: false,
      });
    }
</script>
