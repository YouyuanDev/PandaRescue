<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>servicetype</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <style type="text/css">
        .submit-btn {
            height: 2.3rem;
            width: 100%;
            /*background-color: #81a9c3;*/
            color: white;
            line-height: 2.3rem;
            text-align: center;
        }
        .close-btn {
            display: block;
            float: right;
            padding: 0px 8px;
            color:#000;
            font-size:1.2rem;
        }
        .aui-bar-nav {
            background-color: #fff;
        }
        .aui-list .aui-list-item {
            padding-top: 0.6rem;
            padding-bottom: 0.6rem;
        }
        .aui-list .aui-list-item-input label {
            padding-top: 0.2rem;
        }
        .select-picture .aui-btn {
            width: 100%;
        }

        .service-container {
            overflow-y: scroll;
            padding-top: 2.25rem;
            padding-bottom: 2.25rem;
        }

        .aui-bar {
            position: fixed;
        }

        .service-footer {
            z-index: 101;
        }

        .aui-list .aui-list-item-label {
            color: #696969;
        }

        .aui-list .aui-list-item-input label {
            color: #696969;
        }
    </style>
</head>

<body>
    <header class="aui-bar aui-bar-nav">
        <i class="fa fa-close close-btn"></i>
    </header>
    <div class="aui-content aui-margin-b-15 service-container">
        <input type="hidden" value="0" class="id" />
        <ul class="aui-list aui-form-list">
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-label i18n1" name="servicetype">
                        服务类型
                    </div>
                    <div class="aui-list-item-input service-type">
                        <!-- <label><input class="aui-radio" type="radio" name="demo1" checked>门店服务</label>-->
                    </div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-label i18n1" name="failuretype">
                        故障类型
                    </div>
                    <div class="aui-list-item-input failure-type">
                        <!-- <label><input class="aui-checkbox" type="checkbox" name="checkbox">故障类型1</label>-->
                    </div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-label i18n1" name="uploadpicture">
                        图片上传
                    </div>
                    <div class="aui-list-item-input select-picture">
                        <p>
                            <div class="aui-btn pr-bgcolor pr-fontcolor i18n1" name="selectpicture" onclick="selectPicture();">选择图片</div>
                        </p>
                    </div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner">
                    <div class="aui-list-item-label i18n1" name="adddescription">
                        添加描述
                    </div>
                    <div class="aui-list-item-input">
                        <textarea placeholder="在这里添加描述...." id="mk">

                         </textarea>
                    </div>
                </div>
            </li>
            <li>
                <div class="imgBox">

                </div>
            </li>
        </ul>
    </div>
    <footer class="aui-bar aui-bar-tab service-footer">
        <button class="submit-btn pr-bgcolor pr-color i18n1" name="submit" onclick="submitForm();">提交</button>
    </footer>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<!-- <script type="text/javascript" src="../../script/aui-tab.js"></script> -->

<script type="text/javascript">
    var map;
    apiready = function() {
        map = api.require('bMap');
        closeServiceTypeForm();
        loadAllServiceType();
        loadAllFaultType();
        hlLanguage("../../i18n/");
    }

    function locating() {
        api.sendEvent({
            name: 'sosEvent'
        });
    }
    //加载服务类型
    function loadAllServiceType() {
        var s = 'http://' + serverIP + '/ServiceType/getAllServiceType.action';
        api.ajax({
            url: s,
            method: 'post'
        }, function(ret, errs) {
            if (ret) {
                for (var i = 0; i < ret.length; i++) {
                    var service_type_code = ret[i].service_type_code;
                    var service_type_name = ret[i].service_type_name;
                    var service_type_name_en = ret[i].service_type_name_en;
                    var template = serviceTypeTempalte(service_type_code, service_type_name);
                    $('.service-type').append(template);
                }
            } else {
                api.alert({
                    msg: "加载服务类型失败!"
                });
            }
        });
    }
    //加载故障类型
    function loadAllFaultType() {
        var s = 'http://' + serverIP + '/FailureType/getAllFailureType.action';
        api.ajax({
            url: s,
            method: 'post'
        }, function(ret, errs) {
            if (ret) {
                for (var i = 0; i < ret.length; i++) {
                    var failure_type_code = ret[i].failure_type_code;
                    var failure_type_name = ret[i].failure_type_name;
                    var failure_type_name_en = ret[i].failure_type_name_en;
                    var template = failureTypeTemplate(failure_type_code, failure_type_name);
                    $('.failure-type').append(template);
                }
            } else {
                api.alert({
                    msg: "加载故障类型失败!"
                });
            }
        });
    }
    //关闭表单
    function closeServiceTypeForm() {
        $('.close-btn').click(function() {
            api.closeFrame({
                name: 'service_type'
            });
        });
    }
    //服务类型模板
    function serviceTypeTempalte(val, name) {
        var template = '<label><input class="aui-radio" type="radio" value="' + val + '" name="radio">' + name + '</label>';
        return template;
    }
    //故障类型模板
    function failureTypeTemplate(val, name) {
        var template = '<label><input class="aui-checkbox" value="' + val + '" type="checkbox" name="checkbox">' + name + '</label>';
        return template;
    }
    //表单提交, 生成订单
    function submitForm() {
        $('.submit-btn').attr('disabled',true);
        api.confirm({
            title: '提示',
            msg: '确定提交吗?',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret.buttonIndex == 1) {
                var s = 'http://' + serverIP + '/PersonUser/PersonUserSubmitPendingOrder.action';
                var service_type_code = $("input[name='radio']:checked").val();
                var arr = new Array();
                $('input[name="checkbox"]:checked').each(function() {
                    arr.push($(this).val());
                });
                var failure_type_code = arr.join(",");
                var person_user_location = "";
                var imgUrl = "";
                $('.imgBox  .temp-container img').each(function() {
                    var temp = $(this).attr("data-url");
                    if (temp != undefined) {
                        imgUrl += (temp + ";");
                    }
                });
                map.getLocation({
                    accuracy: '10m',
                    autoStop: true,
                    filter: 1
                }, function(ret, err) {
                    if (ret.status) {
                        var lon = ret.lon;
                        var lat = ret.lat;
                        if (lon != undefined && lat != undefined) {
                            person_user_location = lon + "," + lat;
                            api.ajax({
                                url: s,
                                method: 'post',
                                timeout: 30,
                                dataType: 'json',
                                data: {
                                    values: {
                                        id: $('.id').val(),
                                        person_user_location: person_user_location,
                                        service_type_code: service_type_code,
                                        failure_type_code_list: failure_type_code,
                                        upload_files: imgUrl,
                                        remark: $('#mk').val().trim()
                                    }
                                }
                            }, function(ret, err) { //alert(ret);
                                if (ret) {
                                    api.alert({
                                        msg: ret.message
                                    });
                                    if (ret.success) {
                                        //var order_no=ret.OrderNo;
                                        //alert(order_no+"完成");
                                        //发送订单完成事件
                                        // api.sendEvent({
                                        //     name: 'OrderStatusEvent',
                                        //     extra: {
                                        //         order_no:order_no
                                        //     }
                                        // });
                                        api.closeFrame({
                                            name: 'service_type'
                                        });
                                    }else{
                                        toastFail(ret.message);
                                      if(ret.relogin){
                                        api.sendEvent({
                                            name: 'reloginEvent'
                                        });
                                      }
                                    }
                                } else {
                                    api.alert({
                                        msg: JSON.stringify(err)
                                    });
                                    $('.submit-btn').attr('disabled',false);
                                }
                                $('.submit-btn').attr('disabled',false);
                            });
                        } else {
                            api.alert({
                                msg: "获取定位失败,请重新定位!"
                            });$('.submit-btn').attr('disabled',false);
                        }
                    } else {
                        alert(err.code);$('.submit-btn').attr('disabled',false);
                    }
                });
            }else{
              $('.submit-btn').attr('disabled',false);
            }
        });
    }
</script>

</html>
