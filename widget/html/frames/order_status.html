<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Order Status</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <style type="text/css">
        .order-status {
            background-color: #fff;
            color: #595959;
            border-radius: 3px 3px 0px 0px;
        }

        .cancel-order {
            border-radius: 0px 0px 3px 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="aui-content aui-margin-b-15">
            <div class="aui-bar aui-bar-nav order-status"><i class="fa fa-spinner fa-spin"></i></div>
            <div class="aui-bar aui-bar-nav cancel-order buttons pr-bgcolor">
                <!-- <div class="aui-btn aui-btn-block cancel-order" onclick="cacelOrder();">取消订单</div> -->
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    //var company_data;
    apiready = function() {
            //registerUpdateOrderStatusEvent();
            var data = api.pageParam;
            var account_type = data.account_type;
            var status_code = data.status_code;
            var status_name = data.status_name;
            var status_name_en = data.status_name_en;
            if (account_type != undefined && status_code != undefined) {
                drawStatusPanel(account_type, status_code, status_name, status_name_en);
            }
            // if (status_name != undefined) {
            //     $('.order-status').text(status_name);
            // }
        }
        //
    function drawStatusPanel(account_type, status_code, status_name, status_name_en) {
        toastSuccess("drawStatusPanel");
        //$('.order-status').append('<i class="fa fa-spinner fa-spin"></i>');
        $('.buttons').empty();
        $('.order-status').empty();
        $('.order-status').text(status_name);
        $('.buttons').append(makeButtonTemplate("cancelOrder('" + account_type + "');", "取消订单"));
        if (account_type == "person_user") {
            //pending,confirmed,confirmedpaid,inservice,finished,cancelled,finishedconfirmed
            if (status_code == "confirmed") { //支付
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("payOrder();", status_name + "=>去支付"));
            } else if (status_code == "finished") {
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("confirmFinishedOrder();", status_name + "=>确认完成"));
            } else if (status_code == "cancelled") {
                $('.buttons').empty();
            } else if (status_code == "finishedconfirmed") {
                $('.buttons').empty();
            }
        } else if (account_type == "company_user") {
            if (status_code == "pending") {

            } else if (status_code == "confirmed") {

            } else if (status_code == "confirmedpaid") {
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("startService();", status_name + "=>开始服务"));
            } else if (status_code == "inservice") {
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("finishOrder();", status_name + "=>服务完成"));
            } else if (status_code == "finished") {
                $('.buttons').empty();
            } else if (status_code == "cancelled") {
                $('.buttons').empty();
            } else if (status_code == "finishedconfirmed") {
                $('.buttons').empty();
            }
        }
    }
    //取消订单事件
    function cacelOrder() {
        api.sendEvent({
            name: 'CancelOrderEvent',
            extra: {}
        });
    }

    function makeButtonTemplate(buttonFunctionName, buttonName) {
        var template = '<div class="aui-btn aui-btn-block cancel-order" onclick="' + buttonFunctionName + '">' + buttonName + '</div>';
        return template;
    }

    //调用客户端手机支付
    function aliPay(orderInfo) {
        var aliPay = api.require('aliPay');
        aliPay.payOrder({
            orderInfo: orderInfo
        }, function(ret, err) {
            if (ret) {
                if (ret.code == "9000") {
                    toastSuccess("支付成功");
                } else if (ret.code == "4000") {
                    toastFail("系统异常");
                } else if (ret.code == "4001") {
                    toastFail("数据格式不正确");
                } else if (ret.code == "4003") {
                    toastFail("该用户绑定的支付宝账户被冻结或不允许支付");
                } else if (ret.code == "4004") {
                    toastFail("该用户已解除绑定");
                } else if (ret.code == "4005") {
                    toastFail("绑定失败或没有绑定");
                } else if (ret.code == "4006") {
                    toastFail("订单支付失败");
                } else if (ret.code == "4010") {
                    toastFail("重新绑定账户");
                } else if (ret.code == "6000") {
                    toastFail("支付服务正在进行升级操作");
                } else if (ret.code == "6001") {
                    toastFail("用户中途取消支付操作");
                } else{
                  toastFail("返回码:"+ret.code);
                }

            }else{
              api.alert({
                  title: '系统错误，支付失败',
                  msg: ret.code,
                  buttons: ['确定']
              });
            }

        });
    }


    //请求支付信息
    function payOrder() {

        //var s = 'http://' + serverIP + '/PersonUser/PersonUserPayOrder.action';
        var s = 'http://' + serverIP + '/Order/getCurrentOrderAliPayInfo.action';

        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                    aliPay(ret.orderInfo);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,支付失败!");
            }
        });
    }
    //取消支付
    function cancelOrder(account_type) {
        var s = "";
        if (account_type == "person_user") {
            s = 'http://' + serverIP + '/PersonUser/PersonUserCancelOrder.action';
        } else if (account_type == "company_user") {
            s = 'http://' + serverIP + '/CompanyUser/CompanyUserCancelOrder.action';
        }
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,取消订单失败!");
            }
        });
    }
    //确认完成
    function confirmFinishedOrder() {
        var s = 'http://' + serverIP + '/PersonUser/confirmOrderFinish.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.msg);
                } else {
                    toastFail(ret.msg);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,确认完成失败!");
            }
        });
    }
    //开始服务
    function startService() {
        var s = 'http://' + serverIP + '/CompanyUser/CompanyUserStartService.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,开始服务失败!");
            }
        });
    }
    //服务完成
    function finishOrder() {
        var s = 'http://' + serverIP + '/CompanyUser/CompanyUserFinishService.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,服务完成失败!");
            }
        });
    }
    //监听订单状态改变事件
    // function registerUpdateOrderStatusEvent(){
    //   api.addEventListener({
    //       name: 'UpdateOrderStatusEvent'
    //   }, function(ret, err) {
    //       var status_name=ret.value.status_name;
    //       alert(status_name+"oooooo");
    //       if(status_name!=undefined){
    //           $('.order-status').text(status_name);
    //       }
    //   });
    // }
</script>

</html>
