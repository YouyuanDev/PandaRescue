<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Order Status</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
    <style type="text/css">
        html,
        body {
            height: 100%;
        }
        .container {
            height: 100%;
            width: 100%;
            padding: 5px;
        }
        .order-status {
            background-color: #fff;
            color: #595959;
            border-radius: 3px 3px 0px 0px;
        }

        .cancel-order {
            border-radius: 0px 0px 3px 3px;
        }

        .item-container {
            height: 90px;
            /*border-bottom: 1px solid #F4F4F4;*/
        }

        .item-icon {
            /*width: 3rem;
            height: 3rem;*/
            border-radius: 50%;
        }

        .item-right {
            padding-left: 8px;
        }

        .aui-list .item-fee {
            font-size: 1rem;
        }
        .item-message,.item-phone{
          font-size:1rem;
          padding-right:0.5rem;
        }
        .item-phone{
          padding-left:0.5rem;
        }
        .item-color{
          color:#CCCCCC;
        }
    </style>
</head>

<body>
    <!-- <div class="container"> -->
    <div class="aui-content container">
        <div class="aui-list aui-media-list aui-list-noborder">
            <div class="aui-list-item item-container">
                <div class="aui-media-list-item-inner">

                    <div class="aui-list-item-media item-icon-container">
                        <img src="../../image/default_portrait.png" class="item-icon">
                    </div>
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-text">
                            <div class="aui-list-item-title item-name"></div>
                            <div class="aui-list-item-right item-fee"></div>
                        </div>
                        <div class="aui-list-item-text item-distance-container">
                            <!-- <span class="item-time"></span> -->
                            <span class="item-distance"></span>
                        </div>
                        <div class="aui-list-item-text">
                            <p><span onclick="sendMessage();" class="fa fa-commenting item-message"></span><span onclick="callUser(this);" data-phone="" class="fa fa-phone item-phone"></span></p>
                        </div>
                    </div>

                </div>
            </div>
            <div class="aui-bar aui-bar-nav order-status"><i class="fa fa-spinner fa-spin"></i></div>
            <div class="aui-bar aui-bar-nav cancel-order buttons pr-bgcolor">
                <!-- <div class="aui-btn aui-btn-block cancel-order" onclick="cacelOrder();">取消订单</div> -->
            </div>
        </div>
    </div>
    <!-- </div> -->
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript">
    var map;
    apiready = function() {
            //registerUpdateOrderStatusEvent();
            map = api.require('bMap');
            var data = api.pageParam;
            var account_type = data.account_type;
            var order = data.order;
            //alert(JSON.stringify(order));
            var status_code = order.status_code;
            var status_name = order.status_name;
            var status_name_en = order.status_name_en;
            var order_time = order.order_time;
            if (order_time != undefined) {
                $('.item-time').text(getDate1(order_time));
            }
            var person_lon_lat = order.person_user_location;
            var person_lon, person_lat;
            if (person_lon_lat != undefined && person_lon_lat != "") {
                var arr = person_lon_lat.split(',');
                if (arr.length > 1) {
                    person_lon = arr[0];
                    person_lat = arr[1];
                }
            }
            getRouteDistance(person_lon, person_lat, order.company_location_lon, order.company_location_lat);
            if (account_type == "person_user") {
                $('.item-name').text(order.company_name);
                $('.item-fee').text(order.service_fee + "元");
                var upload_files = order.upload_files;
                var icon_url = "../../image/default_portrait.png";
                if (upload_files != undefined) {
                    var iconArr = upload_files.split(';');
                    if (iconArr.length > 0) {
                        if (iconArr[0] != undefined && iconArr[0] != "") {
                            icon_url = iconArr[0];
                            icon_url = 'http://' + serverIP + '/upload/pictures/' + icon_url;
                        }
                    }
                }
                $('.item-icon').attr('src', icon_url);
                $('.item-phone').attr("disabled",false);
                $('.item-phone').removeClass('item-color');
                $('.item-phone').attr('data-phone',order.cell_phone);
            } else if (account_type == "company_user") {
                $('.item-icon-container').hide();
                $('.item-name').text(getDate1(order_time));
                $('.item-fee').text(order.service_fee + "元");
                $('.item-phone').attr("disabled",true);
                $('.item-phone').addClass('item-color');
            }
            if (account_type != undefined && status_code != undefined) {
                drawStatusPanel(account_type, status_code, status_name, status_name_en);
            }
        }
    function drawStatusPanel(account_type, status_code, status_name, status_name_en) {
        toastSuccess(account_type);
        //$('.order-status').append('<i class="fa fa-spinner fa-spin"></i>');
        $('.buttons').empty();
        $('.order-status').empty();
        $('.order-status').text(status_name);
        $('.buttons').append(makeButtonTemplate("cancelOrder('" + account_type + "');", "取消订单"));
        if (account_type == "person_user") {
            //pending,confirmed,confirmedpaid,inservice,finished,cancelled,finishedconfirmed
            if (status_code == "confirmed") { //支付
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("payOrder();", status_name + "=>去支付"));
            } else if (status_code == "finished") {
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("confirmFinishedOrder();", status_name + "=>确认完成"));
            } else if (status_code == "cancelled") {
                $('.buttons').empty();
            } else if (status_code == "finishedconfirmed") {
                $('.buttons').empty();
            }
        } else if (account_type == "company_user") {
            if (status_code == "pending") {

            } else if (status_code == "confirmed") {

            } else if (status_code == "confirmedpaid") {
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("startService();", status_name + "=>开始服务"));
            } else if (status_code == "inservice") {
                $('.order-status').empty();
                $('.order-status').append(makeButtonTemplate("finishOrder();", status_name + "=>服务完成"));
            } else if (status_code == "finished") {
                $('.buttons').empty();
            } else if (status_code == "cancelled") {
                $('.buttons').empty();
            } else if (status_code == "finishedconfirmed") {
                $('.buttons').empty();
            }
        }
    }

    function makeButtonTemplate(buttonFunctionName, buttonName) {
        var template = '<div class="aui-btn aui-btn-block cancel-order" onclick="' + buttonFunctionName + '">' + buttonName + '</div>';
        return template;
    }

    //调用客户端手机支付
    function aliPay(orderInfo) {
        var aliPay = api.require('aliPay');
        aliPay.payOrder({
            orderInfo: orderInfo
        }, function(ret, err) {
            if (ret) {
                if (ret.code == "9000") {
                    toastSuccess("支付成功");
                } else if (ret.code == "4000") {
                    toastFail("系统异常");
                } else if (ret.code == "4001") {
                    toastFail("数据格式不正确");
                } else if (ret.code == "4003") {
                    toastFail("该用户绑定的支付宝账户被冻结或不允许支付");
                } else if (ret.code == "4004") {
                    toastFail("该用户已解除绑定");
                } else if (ret.code == "4005") {
                    toastFail("绑定失败或没有绑定");
                } else if (ret.code == "4006") {
                    toastFail("订单支付失败");
                } else if (ret.code == "4010") {
                    toastFail("重新绑定账户");
                } else if (ret.code == "6000") {
                    toastFail("支付服务正在进行升级操作");
                } else if (ret.code == "6001") {
                    toastFail("用户中途取消支付操作");
                } else {
                    toastFail("返回码:" + ret.code);
                }

            } else {
                api.alert({
                    title: '系统错误，支付失败',
                    msg: ret.code,
                    buttons: ['确定']
                });
            }

        });
    }


    //请求支付信息
    function payOrder() {

        //var s = 'http://' + serverIP + '/PersonUser/PersonUserPayOrder.action';
        var s = 'http://' + serverIP + '/Order/getCurrentOrderAliPayInfo.action';

        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                    aliPay(ret.orderInfo);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,支付失败!");
            }
        });
    }
    //取消支付
    function cancelOrder(account_type) {
        api.confirm({
            title: '提示',
            msg: '确定取消订单吗?',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            var index = ret.buttonIndex;
            if (index == 1) {
                var s = "";
                if (account_type == "person_user") {
                    s = 'http://' + serverIP + '/PersonUser/PersonUserCancelOrder.action';
                } else if (account_type == "company_user") {
                    s = 'http://' + serverIP + '/CompanyUser/CompanyUserCancelOrder.action';
                }
                api.ajax({
                    url: s,
                    method: 'post',
                    data: {
                        values: {}
                    }
                }, function(ret, errs) {
                    if (ret) {
                        if (ret.success) {
                            toastSuccess(ret.message);
                        } else {
                            toastFail(ret.message);
                            if (ret.relogin) {
                                api.sendEvent({
                                    name: 'reloginEvent'
                                });
                            }
                        }
                    } else {
                        toastFail("系统错误,取消订单失败!");
                    }
                });
            }
        });

    }
    //确认完成
    function confirmFinishedOrder() {
        var s = 'http://' + serverIP + '/PersonUser/confirmOrderFinish.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.msg);
                } else {
                    toastFail(ret.msg);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,确认完成失败!");
            }
        });
    }
    //开始服务
    function startService() {
        var s = 'http://' + serverIP + '/CompanyUser/CompanyUserStartService.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,开始服务失败!");
            }
        });
    }
    //服务完成
    function finishOrder() {
        var s = 'http://' + serverIP + '/CompanyUser/CompanyUserFinishService.action';
        api.ajax({
            url: s,
            method: 'post',
            data: {
                values: {}
            }
        }, function(ret, errs) {
            if (ret) {
                if (ret.success) {
                    toastSuccess(ret.message);
                } else {
                    toastFail(ret.message);
                    if (ret.relogin) {
                        api.sendEvent({
                            name: 'reloginEvent'
                        });
                    }
                }
            } else {
                toastFail("系统错误,服务完成失败!");
            }
        });
    }
    //获取两点间的路线距离
    function getRouteDistance(person_lon, person_lat, company_lon, company_lat) {
        if (person_lon != undefined && person_lat != undefined && company_lon != undefined && company_lat != undefined) {
            map.removeRoute({
                ids: [1]
            });
            //计算路线距离
            map.searchRoute({
                id: 1,
                type: 'drive',
                policy: 'ecar_time_first',
                start: {
                    lon: company_lon,
                    lat: company_lat
                },
                end: {
                    lon: person_lon,
                    lat: person_lat
                }
            }, function(ret, err) {
                if (ret) {
                    if (ret.status) {
                        $('.item-distance').text('驾车：' + getDistance(ret.plans[0].distance) + 'km ' + '耗时：' + convertSecToMin(ret.plans[0].duration) + '分钟');
                        $('.item-time').hide();
                    }else{
                        $('.item-distance').text('暂时未能获取到驾车距离和耗时信息!');
                    }
                } else {
                    $('.item-distance').text('暂时未能获取到驾车距离和耗时信息!');
                    //toastFail(''+err.code);
                }
            });
        }else{
            $('.item-distance').text('暂时未能获取到驾车距离和耗时信息!');
        }
    }
    //拨打电话
    function callUser(obj){
      var phone_no=$(obj).attr('data-phone');
      if(phone_no!=undefined){
        api.call({
          type: 'tel_prompt',
          number: phone_no
        });
      }else{
         toastFail('手机号码不可用!');
      }
    }
    //发送消息
    function sendMessage(){
      toastSuccess("暂未开通此功能!敬请等待!");
    }
    //监听订单状态改变事件
    // function registerUpdateOrderStatusEvent(){
    //   api.addEventListener({
    //       name: 'UpdateOrderStatusEvent'
    //   }, function(ret, err) {
    //       var status_name=ret.value.status_name;
    //       alert(status_name+"oooooo");
    //       if(status_name!=undefined){
    //           $('.order-status').text(status_name);
    //       }
    //   });
    // }
</script>

</html>
